MODULE ELMFIRE_IO

USE ELMFIRE_VARS
USE ELMFIRE_SUBS

IMPLICIT NONE

CONTAINS

! *****************************************************************************
SUBROUTINE SETUP_PARALLEL_IO
! *****************************************************************************

INTEGER :: I,J,N
LOGICAL, PARAMETER :: CALIBRATE=.FALSE.

IF (LEN_TRIM(POPULATION_DENSITY_FILENAME) .GT. 0 .AND. USE_POPULATION_DENSITY) THEN
   USE_POPULATION_DENSITY = .TRUE. 
ELSE
   USE_POPULATION_DENSITY = .FALSE.
ENDIF

IF (LEN_TRIM(REAL_ESTATE_VALUE_FILENAME) .GT. 0 .AND. USE_REAL_ESTATE_VALUE) THEN
   USE_REAL_ESTATE_VALUE = .TRUE.
ELSE
   USE_REAL_ESTATE_VALUE = .FALSE.
ENDIF

IF (LEN_TRIM(LAND_VALUE_FILENAME) .GT. 0 .AND. USE_LAND_VALUE) THEN
   USE_LAND_VALUE = .TRUE. 
ELSE
   USE_LAND_VALUE = .FALSE.
ENDIF

N = NPROC_IRANK0
PARALLEL_IO_RANK(:) = -1
IF (N .GT. 1) THEN

! 1 : WS header
! 2 : ASP header
   PARALLEL_IO_RANK(1) = 0
   PARALLEL_IO_RANK(2) = 1

! 3: WS
! 4: WD
! 5: M1
! 6: M10
! 7: M100
   I = 0
   DO J = 3, 7
      PARALLEL_IO_RANK(J) = I
      I = I + 1
      IF (I .GT. N - 1) I = 0
   ENDDO

! 8: ERC
   IF (USE_ERC) THEN
      I = I + 1
      IF (I .GT. N - 1) I = 0
      PARALLEL_IO_RANK(8) = I
   ENDIF

!  9: LH
! 10: LW 
! 11: MFOL
   DO J = 9, 11
      I = I + 1
      IF (I .GT. N - 1) I = 0
      PARALLEL_IO_RANK(J) = I
   ENDDO

! 12: IGN_MASK
   I = 0
   IF (USE_IGNITION_MASK) THEN
      PARALLEL_IO_RANK(12) = I
      I = I + 1
   ENDIF

! 13: ASP
! 14: CBH
! 15: CBD
! 16: CC
! 17: CH
! 18: DEM
! 19: FBFM
! 20: SLP
! 21: ADJ
! 22: PHI0
   DO J = 13, 22
      PARALLEL_IO_RANK(J) = I
      I = I + 1
      IF (I .GT. N - 1) I = 0
   ENDDO

! 23: POPULATION_DENSITY
   IF (USE_POPULATION_DENSITY) THEN
      I = I + 1
      IF (I .GT. N - 1) I = 0
      PARALLEL_IO_RANK(23) = I
   ENDIF

! 24: REAL_ESTATE_VALUE
   IF (USE_REAL_ESTATE_VALUE) THEN
      I = I + 1
      IF (I .GT. N - 1) I = 0
      PARALLEL_IO_RANK(24) = I
   ENDIF

! 25: LAND_VALUE
   IF (USE_LAND_VALUE) THEN
      I = I + 1
      IF (I .GT. N - 1) I = 0
      PARALLEL_IO_RANK(25) = I
   ENDIF

! 26: CALIBRATION_TARGET
   IF (CALIBRATE) THEN
      I = I + 1
      IF (I .GT. N - 1) I = 0
      PARALLEL_IO_RANK(26) = I
   ENDIF

! 27: SDI
   IF (USE_SDI) THEN
      I = I + 1
      IF (I .GT. N - 1) I = 0
      PARALLEL_IO_RANK(27) = I
   ENDIF

! 28-32: Building spread (previously Hamada model) parameters
   IF (USE_BLDG_SPREAD_MODEL) THEN
      DO J = 28, 32
         I = I + 1
         IF (I .GT. N - 1) I = 0
         PARALLEL_IO_RANK(J) = I
      ENDDO
   ENDIF

! 33: Pyromes
   IF (USE_PYROMES) THEN
      I = I + 1
      IF (I .GT. N - 1) I = 0
      PARALLEL_IO_RANK(33) = I
   ENDIF

! 34: TIMES_BURNED
! 35: SURFACE_FIRE_AREA
! 36: CROWN_FIRE_AREA
! 37: SURFACE_FIRE_VOLUME
! 38: AFFECTED_POPULATION
! 39: AFFECTED_REAL_ESTATE_VALUE
! 40: AFFECTED_LAND_VALUE
   I = 0
   DO J = 34, 40
      PARALLEL_IO_RANK(J) = I
      I = I + 1
      IF (I .GT. N - 1) I = 0
   ENDDO
ELSE
   PARALLEL_IO_RANK(:) = 0
ENDIF

! *****************************************************************************
END SUBROUTINE SETUP_PARALLEL_IO
! *****************************************************************************

! *****************************************************************************
SUBROUTINE READ_WEATHER_FUEL_TOPOGRAPHY
! *****************************************************************************

INTEGER :: ICOL, IROW
REAL :: CONSTANT_LH, CONSTANT_LW, CONSTANT_FMC, RX
INTEGER :: IERR
LOGICAL, PARAMETER :: NOISE=.TRUE.

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(3)) THEN
   CALL READ_BSQ_RASTER (WS,   WEATHER_DIRECTORY, WS_FILENAME)
   IF (WS_AT_10M) WHERE(WS%R4(:,:,:) .NE. WS%NODATA_VALUE) WS%R4(:,:,:) = 0.87 * WS%R4(:,:,:)
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(4)) CALL READ_BSQ_RASTER (WD,   WEATHER_DIRECTORY, WD_FILENAME)

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(5)) THEN
   CALL READ_BSQ_RASTER (M1,   WEATHER_DIRECTORY, M1_FILENAME)
   IF (DEAD_MC_IN_PERCENT) WHERE (M1%R4  (:,:,:) .NE. M1%NODATA_VALUE  ) M1%R4  (:,:,:) = 0.01 * M1%R4  (:,:,:)
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(6)) THEN
   CALL READ_BSQ_RASTER (M10,  WEATHER_DIRECTORY, M10_FILENAME)
   IF (DEAD_MC_IN_PERCENT) WHERE (M10%R4 (:,:,:) .NE. M10%NODATA_VALUE ) M10%R4 (:,:,:) = 0.01 * M10%R4 (:,:,:)
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(7)) THEN
   CALL READ_BSQ_RASTER (M100, WEATHER_DIRECTORY, M100_FILENAME)
   IF (DEAD_MC_IN_PERCENT) WHERE (M100%R4(:,:,:) .NE. M100%NODATA_VALUE) M100%R4(:,:,:) = 0.01 * M100%R4(:,:,:)
ENDIF

IF (USE_ERC .AND. IRANK_WORLD .EQ. PARALLEL_IO_RANK(8) ) THEN
   CALL READ_BSQ_RASTER(ERC, WEATHER_DIRECTORY, ERC_FILENAME)
   CALL ERC_IGNITION_FACTOR (ERC, IGNFAC, 1, ERC%NBANDS)
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(9)) THEN
   CONSTANT_LH  = -9999.
   IF (USE_CONSTANT_LH) THEN
      CONSTANT_LH = LH_MOISTURE_CONTENT
      IF (LIVE_MC_IN_PERCENT) CONSTANT_LH = CONSTANT_LH * 0.01
   ENDIF
   IF (CONSTANT_LH .GT. 0. ) THEN
      MLH%R4 (:,:,:) = CONSTANT_LH
   ELSE
      CALL READ_BSQ_RASTER(MLH, WEATHER_DIRECTORY, MLH_FILENAME)
      IF (LIVE_MC_IN_PERCENT) MLH%R4(:,:,:) = 0.01 * MLH%R4(:,:,:)
   ENDIF
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(10)) THEN
   CONSTANT_LW  = -9999.
   IF (USE_CONSTANT_LW) THEN
      CONSTANT_LW = LW_MOISTURE_CONTENT
      IF (LIVE_MC_IN_PERCENT) CONSTANT_LW = CONSTANT_LW * 0.01
   ENDIF
   IF (CONSTANT_LW .GT. 0. ) THEN
      MLW%R4 (:,:,:) = CONSTANT_LW
   ELSE
      CALL READ_BSQ_RASTER(MLW, WEATHER_DIRECTORY, MLW_FILENAME)
      IF (LIVE_MC_IN_PERCENT) MLW%R4(:,:,:) = 0.01 * MLW%R4(:,:,:)
   ENDIF
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(11)) THEN
   CONSTANT_FMC = -9999.
   IF (USE_CONSTANT_FMC) THEN
      CONSTANT_FMC = FOLIAR_MOISTURE_CONTENT
   ENDIF
   IF (CONSTANT_FMC .GT. 0. ) THEN
      MFOL%R4 (:,:,:) = CONSTANT_FMC
   ELSE
      CALL READ_BSQ_RASTER(MFOL, WEATHER_DIRECTORY, FMC_FILENAME)
   ENDIF
ENDIF

CALL MPI_BARRIER(MPI_COMM_WORLD, IERR)
IF (NPROC .GT. 1) THEN
   CALL MPI_BCAST_RASTER_HEADER(WS   , PARALLEL_IO_RANK(3), .FALSE.)
   CALL MPI_BCAST_RASTER_HEADER(WD   , PARALLEL_IO_RANK(4), .FALSE.)
   CALL MPI_BCAST_RASTER_HEADER(M1   , PARALLEL_IO_RANK(5), .FALSE.)
   CALL MPI_BCAST_RASTER_HEADER(M10  , PARALLEL_IO_RANK(6), .FALSE.)
   CALL MPI_BCAST_RASTER_HEADER(M100 , PARALLEL_IO_RANK(7), .FALSE.)
   IF (USE_ERC) THEN
      CALL MPI_BCAST_RASTER_HEADER(ERC    , PARALLEL_IO_RANK(8), .FALSE.)
      CALL MPI_BCAST_RASTER_HEADER(IGNFAC , PARALLEL_IO_RANK(8), .FALSE.)
   ENDIF
ENDIF

IF (IRANK_WORLD .EQ. 0) WRITE(*,*) 'Reading fuel and topography rasters'

IF (USE_IGNITION_MASK .AND. IRANK_WORLD .EQ. PARALLEL_IO_RANK(12)) THEN
   CALL READ_BSQ_RASTER (IGN_MASK, FUELS_AND_TOPOGRAPHY_DIRECTORY, IGNITION_MASK_FILENAME)
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(13)) THEN
   CALL READ_BSQ_RASTER (ASP , FUELS_AND_TOPOGRAPHY_DIRECTORY, ASP_FILENAME)
   IF (TRIM(ASP%PIXELTYPE) .EQ. 'SIGNEDINT') THEN
      ASP%R4(:,:,1) = REAL(ASP%I2(:,:,1))
      DEALLOCATE(ASP%I2)
      ASP%PIXELTYPE='FLOAT     '
   ENDIF
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(14)) THEN
   CALL READ_BSQ_RASTER (CBH , FUELS_AND_TOPOGRAPHY_DIRECTORY, CBH_FILENAME)
   IF (TRIM(CBH%PIXELTYPE) .EQ. 'SIGNEDINT') THEN
      CBH%R4(:,:,1) = REAL(CBH%I2(:,:,1))
      DEALLOCATE(CBH%I2)
      CBH%PIXELTYPE='FLOAT     '
   ENDIF
   IF (CBH_TIMES_10 ) WHERE(CBH%R4(:,:,1) .NE. CBH%NODATA_VALUE) CBH%R4(:,:,1) = 0.10*CBH%R4(:,:,1) ! m
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(15)) THEN
   CALL READ_BSQ_RASTER (CBD , FUELS_AND_TOPOGRAPHY_DIRECTORY, CBD_FILENAME)
   IF (TRIM(CBD%PIXELTYPE) .EQ. 'SIGNEDINT') THEN
      CBD%R4(:,:,1) = REAL(CBD%I2(:,:,1))
      DEALLOCATE(CBD%I2)
      CBD%PIXELTYPE='FLOAT     '
   ENDIF
   IF (CBD_TIMES_100) WHERE(CBD%R4(:,:,1) .NE. CBD%NODATA_VALUE) CBD%R4(:,:,1) = 0.01*CBD%R4(:,:,1) ! kg/m3
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(16)) THEN
   CALL READ_BSQ_RASTER (CC  , FUELS_AND_TOPOGRAPHY_DIRECTORY, CC_FILENAME)
   IF (TRIM(CC%PIXELTYPE) .EQ. 'SIGNEDINT') THEN
      CC%R4(:,:,1) = REAL(CC%I2(:,:,1))
      DEALLOCATE(CC%I2)
      CC%PIXELTYPE='FLOAT     '
   ENDIF
   IF (CC_IN_PERCENT) WHERE(CC%R4 (:,:,1) .NE. CC%NODATA_VALUE ) CC%R4 (:,:,1) = 0.01*CC%R4 (:,:,1) ! -
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(17)) THEN
   CALL READ_BSQ_RASTER (CH  , FUELS_AND_TOPOGRAPHY_DIRECTORY, CH_FILENAME )
   IF (TRIM(CH%PIXELTYPE) .EQ. 'SIGNEDINT') THEN
      CH%R4(:,:,1) = REAL(CH%I2(:,:,1))
      DEALLOCATE(CH%I2)
      CH%PIXELTYPE='FLOAT     '
   ENDIF
   IF (CH_TIMES_10  ) WHERE(CH%R4 (:,:,1) .NE. CH%NODATA_VALUE ) CH%R4 (:,:,1) = 0.10*CH%R4 (:,:,1) ! m
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(18) .AND. MODE .NE. 2) THEN
   CALL READ_BSQ_RASTER (DEM , FUELS_AND_TOPOGRAPHY_DIRECTORY, DEM_FILENAME)
   IF (TRIM(DEM%PIXELTYPE) .EQ. 'SIGNEDINT') THEN
      DEM%R4(:,:,1)= REAL(DEM%I2(:,:,1))
      DEALLOCATE(DEM%I2)
      DEM%PIXELTYPE='FLOAT     '
   ENDIF
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(19)) CALL READ_BSQ_RASTER (FBFM, FUELS_AND_TOPOGRAPHY_DIRECTORY, FBFM_FILENAME)

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(20)) THEN
   CALL READ_BSQ_RASTER (SLP , FUELS_AND_TOPOGRAPHY_DIRECTORY, SLP_FILENAME)
   IF (TRIM(SLP%PIXELTYPE) .EQ. 'SIGNEDINT') THEN
      SLP%R4(:,:,1) = REAL(SLP%I2(:,:,1))
      DEALLOCATE(SLP%I2)
      SLP%PIXELTYPE='FLOAT     '
   ENDIF
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(21) ) CALL READ_BSQ_RASTER (ADJ , FUELS_AND_TOPOGRAPHY_DIRECTORY, ADJ_FILENAME)
IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(22) .AND. MODE .NE. 2) THEN
   CALL READ_BSQ_RASTER (PHI0 ,FUELS_AND_TOPOGRAPHY_DIRECTORY, PHI_FILENAME)
   WHERE(PHI0%R4(:,:,1) .LT.   -1.1) PHI0%R4(:,:,1) = 1.0
   IF (NOISE) THEN
      DO IROW = 1, PHI0%NROWS
      DO ICOL = 1, PHI0%NCOLS
         CALL RANDOM_NUMBER(RX)
         IF (PHI0%R4(ICOL,IROW,1) .GT. 0.9) PHI0%R4(ICOL,IROW,1) = PHI0%R4(ICOL,IROW,1) + 1E-4 * (0.5 - RX)
      ENDDO
      ENDDO
   ENDIF
ENDIF

IF (USE_POPULATION_DENSITY .AND. IRANK_WORLD .EQ. PARALLEL_IO_RANK(23)) CALL READ_BSQ_RASTER (POPULATION_DENSITY, FUELS_AND_TOPOGRAPHY_DIRECTORY, POPULATION_DENSITY_FILENAME)
IF (USE_REAL_ESTATE_VALUE  .AND. IRANK_WORLD .EQ. PARALLEL_IO_RANK(24)) CALL READ_BSQ_RASTER (REAL_ESTATE_VALUE , FUELS_AND_TOPOGRAPHY_DIRECTORY, REAL_ESTATE_VALUE_FILENAME )
IF (USE_LAND_VALUE         .AND. IRANK_WORLD .EQ. PARALLEL_IO_RANK(25)) CALL READ_BSQ_RASTER (LAND_VALUE        , FUELS_AND_TOPOGRAPHY_DIRECTORY, LAND_VALUE_FILENAME        )
IF (USE_SDI                .AND. IRANK_WORLD .EQ. PARALLEL_IO_RANK(27)) CALL READ_BSQ_RASTER (SDI               , FUELS_AND_TOPOGRAPHY_DIRECTORY, SDI_FILENAME               )

IF (USE_BLDG_SPREAD_MODEL) THEN
   IF (USE_CONSTANT_BLDG_SPREAD_MODEL_PARAMS) THEN
      IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(28)) BLDG_AREA%R4            (:,:,:) = BLDG_AREA_CONSTANT
      IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(29)) BLDG_SEPARATION_DIST%R4 (:,:,:) = BLDG_SEPARATION_DIST_CONSTANT
      IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(30)) BLDG_NONBURNABLE_FRAC%R4(:,:,:) = BLDG_NONBURNABLE_FRAC_CONSTANT
      IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(31)) BLDG_FOOTPRINT_FRAC%R4  (:,:,:) = BLDG_FOOTPRINT_FRAC_CONSTANT
      IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(32)) BLDG_FUEL_MODEL%I2      (:,:,:) = BLDG_FUEL_MODEL_CONSTANT
   ELSE
      IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(28)) CALL READ_BSQ_RASTER (BLDG_AREA            , FUELS_AND_TOPOGRAPHY_DIRECTORY, BLDG_AREA_FILENAME )
      IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(29)) CALL READ_BSQ_RASTER (BLDG_SEPARATION_DIST , FUELS_AND_TOPOGRAPHY_DIRECTORY, BLDG_SEPARATION_DIST_FILENAME )
      IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(30)) CALL READ_BSQ_RASTER (BLDG_NONBURNABLE_FRAC, FUELS_AND_TOPOGRAPHY_DIRECTORY, BLDG_NONBURNABLE_FRAC_FILENAME)
      IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(31)) CALL READ_BSQ_RASTER (BLDG_FOOTPRINT_FRAC  , FUELS_AND_TOPOGRAPHY_DIRECTORY, BLDG_FOOTPRINT_FRAC_FILENAME)
      IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(32)) CALL READ_BSQ_RASTER (BLDG_FUEL_MODEL      , FUELS_AND_TOPOGRAPHY_DIRECTORY, BLDG_FUEL_MODEL_FILENAME)
   ENDIF
ENDIF

IF (USE_PYROMES .AND. IRANK_WORLD .EQ. PARALLEL_IO_RANK(33)) CALL READ_BSQ_RASTER (PYROMES, FUELS_AND_TOPOGRAPHY_DIRECTORY, PYROMES_FILENAME)

CALL MPI_BARRIER(MPI_COMM_WORLD, IERR)
IF (NPROC .GT. 1) THEN
   IF (USE_IGNITION_MASK) CALL MPI_BCAST_RASTER_HEADER(IGN_MASK  , PARALLEL_IO_RANK(12), .FALSE.)
   CALL MPI_BCAST_RASTER_HEADER(ASP       , PARALLEL_IO_RANK(13), .FALSE.)
   CALL MPI_BCAST_RASTER_HEADER(CBH       , PARALLEL_IO_RANK(14), .FALSE.)
   CALL MPI_BCAST_RASTER_HEADER(CBD       , PARALLEL_IO_RANK(15), .FALSE.)
   CALL MPI_BCAST_RASTER_HEADER(CC        , PARALLEL_IO_RANK(16), .FALSE.)
   CALL MPI_BCAST_RASTER_HEADER(CH        , PARALLEL_IO_RANK(17), .FALSE.)
   IF (MODE .NE. 2) CALL MPI_BCAST_RASTER_HEADER(DEM  , PARALLEL_IO_RANK(18), .FALSE.)
   CALL MPI_BCAST_RASTER_HEADER(FBFM      , PARALLEL_IO_RANK(19), .FALSE.)
   CALL MPI_BCAST_RASTER_HEADER(SLP       , PARALLEL_IO_RANK(20), .FALSE.)
   CALL MPI_BCAST_RASTER_HEADER(ADJ       , PARALLEL_IO_RANK(21), .FALSE.)
   IF (MODE .NE. 2) CALL MPI_BCAST_RASTER_HEADER(PHI0 , PARALLEL_IO_RANK(22), .FALSE.)
   IF (USE_POPULATION_DENSITY) CALL MPI_BCAST_RASTER_HEADER(POPULATION_DENSITY , PARALLEL_IO_RANK(23), .FALSE.)
   IF (USE_REAL_ESTATE_VALUE ) CALL MPI_BCAST_RASTER_HEADER(REAL_ESTATE_VALUE   ,PARALLEL_IO_RANK(24), .FALSE.)
   IF (USE_LAND_VALUE        ) CALL MPI_BCAST_RASTER_HEADER(LAND_VALUE         , PARALLEL_IO_RANK(25), .FALSE.)
   IF (USE_SDI               ) CALL MPI_BCAST_RASTER_HEADER(SDI                , PARALLEL_IO_RANK(27), .FALSE.)
   IF (USE_BLDG_SPREAD_MODEL) THEN
      CALL MPI_BCAST_RASTER_HEADER(BLDG_AREA            , PARALLEL_IO_RANK(28), .FALSE.)
      CALL MPI_BCAST_RASTER_HEADER(BLDG_SEPARATION_DIST , PARALLEL_IO_RANK(29), .FALSE.)
      CALL MPI_BCAST_RASTER_HEADER(BLDG_NONBURNABLE_FRAC, PARALLEL_IO_RANK(30), .FALSE.)
      CALL MPI_BCAST_RASTER_HEADER(BLDG_FOOTPRINT_FRAC  , PARALLEL_IO_RANK(31), .FALSE.)
      CALL MPI_BCAST_RASTER_HEADER(BLDG_FUEL_MODEL      , PARALLEL_IO_RANK(32), .FALSE.)
   ENDIF
   IF (USE_PYROMES) CALL MPI_BCAST_RASTER_HEADER(PYROMES, PARALLEL_IO_RANK(33), .FALSE.)
ENDIF

! *****************************************************************************
END SUBROUTINE READ_WEATHER_FUEL_TOPOGRAPHY
! *****************************************************************************

! *****************************************************************************
SUBROUTINE READ_WEATHER_FUEL_TOPOGRAPHY_TILED
! *****************************************************************************

INTEGER :: ICOL, IROW
REAL :: CONSTANT_LH, CONSTANT_LW, CONSTANT_FMC, RX
INTEGER :: IERR
LOGICAL, PARAMETER :: NOISE=.TRUE.
CHARACTER(400) :: FN

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(3)) THEN
   FN = TRIM(WEATHER_DIRECTORY) // TRIM(WS_FILENAME)
   CALL READ_BSQ_RASTER_EXISTING_TILED (WS,FN)
   IF (WS_AT_10M) WHERE(WS%R4(:,:,:) .NE. WS%NODATA_VALUE) WS%R4(:,:,:) = 0.87 * WS%R4(:,:,:) 
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(4)) THEN
   FN = TRIM(WEATHER_DIRECTORY) // TRIM(WD_FILENAME)
   CALL READ_BSQ_RASTER_EXISTING_TILED (WD,FN)
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(5)) THEN
   FN = TRIM(WEATHER_DIRECTORY) // TRIM(M1_FILENAME)
   CALL READ_BSQ_RASTER_EXISTING_TILED (M1,FN)
   IF (DEAD_MC_IN_PERCENT) WHERE (M1%R4  (:,:,:) .NE. M1%NODATA_VALUE  ) M1%R4  (:,:,:) = 0.01 * M1%R4  (:,:,:)
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(6)) THEN
   FN = TRIM(WEATHER_DIRECTORY) // TRIM(M10_FILENAME)
   CALL READ_BSQ_RASTER_EXISTING_TILED (M10,FN)
   IF (DEAD_MC_IN_PERCENT) WHERE (M10%R4 (:,:,:) .NE. M10%NODATA_VALUE ) M10%R4 (:,:,:) = 0.01 * M10%R4 (:,:,:)
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(7)) THEN
   FN = TRIM(WEATHER_DIRECTORY) // TRIM(M100_FILENAME)
   CALL READ_BSQ_RASTER_EXISTING_TILED (M100,FN)
   IF (DEAD_MC_IN_PERCENT) WHERE (M100%R4(:,:,:) .NE. M100%NODATA_VALUE) M100%R4(:,:,:) = 0.01 * M100%R4(:,:,:)
ENDIF

IF (USE_ERC .AND. IRANK_WORLD .EQ. PARALLEL_IO_RANK(8) ) THEN
   FN = TRIM(WEATHER_DIRECTORY) // TRIM(ERC_FILENAME)
   CALL READ_BSQ_RASTER_EXISTING_TILED(ERC,FN)
   CALL ERC_IGNITION_FACTOR (ERC, IGNFAC, 1, ERC%NBANDS)
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(9)) THEN
   CONSTANT_LH  = -9999.
   IF (USE_CONSTANT_LH) THEN
      CONSTANT_LH = LH_MOISTURE_CONTENT
      IF (LIVE_MC_IN_PERCENT) CONSTANT_LH = CONSTANT_LH * 0.01
   ENDIF
   IF (CONSTANT_LH .GT. 0. ) THEN
      MLH%R4 (:,:,:) = CONSTANT_LH
   ELSE
      FN = TRIM(WEATHER_DIRECTORY) // TRIM(MLH_FILENAME)
      CALL READ_BSQ_RASTER_EXISTING_TILED(MLH,FN)
      IF (LIVE_MC_IN_PERCENT) MLH%R4(:,:,:) = 0.01 * MLH%R4(:,:,:)
   ENDIF
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(10)) THEN
   CONSTANT_LW  = -9999.
   IF (USE_CONSTANT_LW) THEN
      CONSTANT_LW = LW_MOISTURE_CONTENT
      IF (LIVE_MC_IN_PERCENT) CONSTANT_LW = CONSTANT_LW * 0.01
   ENDIF
   IF (CONSTANT_LW .GT. 0. ) THEN
      MLW%R4 (:,:,:) = CONSTANT_LW
   ELSE
      FN = TRIM(WEATHER_DIRECTORY) // TRIM(MLW_FILENAME)
      CALL READ_BSQ_RASTER_EXISTING_TILED(MLW,FN)
      IF (LIVE_MC_IN_PERCENT) MLW%R4(:,:,:) = 0.01 * MLW%R4(:,:,:)
   ENDIF
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(11)) THEN
   CONSTANT_FMC = -9999.
   IF (USE_CONSTANT_FMC) THEN
      CONSTANT_FMC = FOLIAR_MOISTURE_CONTENT
   ENDIF
   IF (CONSTANT_FMC .GT. 0. ) THEN
      MFOL%R4 (:,:,:) = CONSTANT_FMC
   ELSE
      FN = TRIM(WEATHER_DIRECTORY) // TRIM(FMC_FILENAME)
      CALL READ_BSQ_RASTER_EXISTING_TILED(MFOL,FN)
   ENDIF
ENDIF

CALL MPI_BARRIER(MPI_COMM_WORLD, IERR)
IF (NPROC .GT. 1) THEN
   CALL MPI_BCAST_RASTER_HEADER(WS   , PARALLEL_IO_RANK(3), .FALSE.)
   CALL MPI_BCAST_RASTER_HEADER(WD   , PARALLEL_IO_RANK(4), .FALSE.)
   CALL MPI_BCAST_RASTER_HEADER(M1   , PARALLEL_IO_RANK(5), .FALSE.)
   CALL MPI_BCAST_RASTER_HEADER(M10  , PARALLEL_IO_RANK(6), .FALSE.)
   CALL MPI_BCAST_RASTER_HEADER(M100 , PARALLEL_IO_RANK(7), .FALSE.)
   IF (USE_ERC) THEN
      CALL MPI_BCAST_RASTER_HEADER(ERC    , PARALLEL_IO_RANK(8), .FALSE.)
      CALL MPI_BCAST_RASTER_HEADER(IGNFAC , PARALLEL_IO_RANK(8), .FALSE.)
   ENDIF
ENDIF

IF (IRANK_WORLD .EQ. 0) WRITE(*,*) 'Reading fuel and topography rasters'

IF (USE_IGNITION_MASK .AND. IRANK_WORLD .EQ. PARALLEL_IO_RANK(12)) THEN
   FN = TRIM(FUELS_AND_TOPOGRAPHY_DIRECTORY) // TRIM(IGNITION_MASK_FILENAME)
   CALL READ_BSQ_RASTER_EXISTING_TILED (IGN_MASK,FN)
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(13)) THEN
   FN = TRIM(FUELS_AND_TOPOGRAPHY_DIRECTORY) // TRIM(ASP_FILENAME)
   CALL READ_BSQ_RASTER_EXISTING_TILED (ASP,FN)
   IF (TRIM(ASP%PIXELTYPE) .EQ. 'SIGNEDINT') THEN
      ASP%R4(:,:,1) = REAL(ASP%I2(:,:,1))
      DEALLOCATE(ASP%I2)
      ASP%PIXELTYPE='FLOAT     '
   ENDIF
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(14)) THEN
   FN = TRIM(FUELS_AND_TOPOGRAPHY_DIRECTORY) // TRIM(CBH_FILENAME)
   CALL READ_BSQ_RASTER_EXISTING_TILED (CBH,FN)
   IF (TRIM(CBH%PIXELTYPE) .EQ. 'SIGNEDINT') THEN
      CBH%R4(:,:,1) = REAL(CBH%I2(:,:,1))
      DEALLOCATE(CBH%I2)
      CBH%PIXELTYPE='FLOAT     '
   ENDIF
   IF (CBH_TIMES_10 ) WHERE(CBH%R4(:,:,1) .NE. CBH%NODATA_VALUE) CBH%R4(:,:,1) = 0.10*CBH%R4(:,:,1) ! m
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(15)) THEN
   FN = TRIM(FUELS_AND_TOPOGRAPHY_DIRECTORY) // TRIM(CBD_FILENAME)
   CALL READ_BSQ_RASTER_EXISTING_TILED (CBD,FN)
   IF (TRIM(CBD%PIXELTYPE) .EQ. 'SIGNEDINT') THEN
      CBD%R4(:,:,1) = REAL(CBD%I2(:,:,1))
      DEALLOCATE(CBD%I2)
      CBD%PIXELTYPE='FLOAT     '
   ENDIF
   IF (CBD_TIMES_100) WHERE(CBD%R4(:,:,1) .NE. CBD%NODATA_VALUE) CBD%R4(:,:,1) = 0.01*CBD%R4(:,:,1) ! kg/m3
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(16)) THEN
   FN = TRIM(FUELS_AND_TOPOGRAPHY_DIRECTORY) // TRIM(CC_FILENAME)
   CALL READ_BSQ_RASTER_EXISTING_TILED (CC,FN)
   IF (TRIM(CC%PIXELTYPE) .EQ. 'SIGNEDINT') THEN
      CC%R4(:,:,1) = REAL(CC%I2(:,:,1))
      DEALLOCATE(CC%I2)
      CC%PIXELTYPE='FLOAT     '
   ENDIF
   IF (CC_IN_PERCENT) WHERE(CC%R4 (:,:,1) .NE. CC%NODATA_VALUE ) CC%R4 (:,:,1) = 0.01*CC%R4 (:,:,1) ! -
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(17)) THEN
   FN = TRIM(FUELS_AND_TOPOGRAPHY_DIRECTORY) // TRIM(CH_FILENAME)
   CALL READ_BSQ_RASTER_EXISTING_TILED (CH,FN)
   IF (TRIM(CH%PIXELTYPE) .EQ. 'SIGNEDINT') THEN
      CH%R4(:,:,1) = REAL(CH%I2(:,:,1))
      DEALLOCATE(CH%I2)
      CH%PIXELTYPE='FLOAT     '
   ENDIF
   IF (CH_TIMES_10  ) WHERE(CH%R4 (:,:,1) .NE. CH%NODATA_VALUE ) CH%R4 (:,:,1) = 0.10*CH%R4 (:,:,1) ! m
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(18) .AND. MODE .NE. 2) THEN
   FN = TRIM(FUELS_AND_TOPOGRAPHY_DIRECTORY) // TRIM(DEM_FILENAME)
   CALL READ_BSQ_RASTER_EXISTING_TILED (DEM, FN)
   IF (TRIM(DEM%PIXELTYPE) .EQ. 'SIGNEDINT') THEN
      DEM%R4(:,:,1)= REAL(DEM%I2(:,:,1))
      DEALLOCATE(DEM%I2)
      DEM%PIXELTYPE='FLOAT     '
   ENDIF
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(19)) THEN
   FN = TRIM(FUELS_AND_TOPOGRAPHY_DIRECTORY) // TRIM(FBFM_FILENAME)
   CALL READ_BSQ_RASTER_EXISTING_TILED (FBFM,FN)
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(20)) THEN
   FN = TRIM(FUELS_AND_TOPOGRAPHY_DIRECTORY) // TRIM(SLP_FILENAME)
   CALL READ_BSQ_RASTER_EXISTING_TILED (SLP,FN)
   IF (TRIM(SLP%PIXELTYPE) .EQ. 'SIGNEDINT') THEN
      SLP%R4(:,:,1) = REAL(SLP%I2(:,:,1))
      DEALLOCATE(SLP%I2)
      SLP%PIXELTYPE='FLOAT     '
   ENDIF
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(21) ) THEN
   FN = TRIM(FUELS_AND_TOPOGRAPHY_DIRECTORY) // TRIM(ADJ_FILENAME)
   CALL READ_BSQ_RASTER_EXISTING_TILED (ADJ, FN)
ENDIF

IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(22) .AND. MODE .NE. 2) THEN
   FN = TRIM(FUELS_AND_TOPOGRAPHY_DIRECTORY) // TRIM(PHI_FILENAME)
   CALL READ_BSQ_RASTER_EXISTING_TILED (PHI0,FN)
   IF (NOISE) THEN
      DO IROW = 1, PHI0%NROWS
      DO ICOL = 1, PHI0%NCOLS
         CALL RANDOM_NUMBER(RX)
         IF (PHI0%R4(ICOL,IROW,1) .GT. 0.9) PHI0%R4(ICOL,IROW,1) = PHI0%R4(ICOL,IROW,1) + 1E-4 * (0.5 - RX)
      ENDDO
      ENDDO
   ENDIF
ENDIF

IF (USE_POPULATION_DENSITY .AND. IRANK_WORLD .EQ. PARALLEL_IO_RANK(23)) THEN
   FN = TRIM(FUELS_AND_TOPOGRAPHY_DIRECTORY) // TRIM(POPULATION_DENSITY_FILENAME)
   CALL READ_BSQ_RASTER_EXISTING_TILED (POPULATION_DENSITY,FN)
ENDIF

IF (USE_REAL_ESTATE_VALUE  .AND. IRANK_WORLD .EQ. PARALLEL_IO_RANK(24)) THEN
   FN = TRIM(FUELS_AND_TOPOGRAPHY_DIRECTORY) // TRIM(REAL_ESTATE_VALUE_FILENAME)
   CALL READ_BSQ_RASTER_EXISTING_TILED (REAL_ESTATE_VALUE,FN)
ENDIF

IF (USE_LAND_VALUE         .AND. IRANK_WORLD .EQ. PARALLEL_IO_RANK(25)) THEN
   FN = TRIM(FUELS_AND_TOPOGRAPHY_DIRECTORY) // TRIM(LAND_VALUE_FILENAME)
   CALL READ_BSQ_RASTER_EXISTING_TILED (LAND_VALUE,FN)
ENDIF

IF (USE_SDI                .AND. IRANK_WORLD .EQ. PARALLEL_IO_RANK(27)) THEN
   FN = TRIM(FUELS_AND_TOPOGRAPHY_DIRECTORY) // TRIM(SDI_FILENAME)
   CALL READ_BSQ_RASTER_EXISTING_TILED (SDI,FN)
ENDIF

IF (USE_BLDG_SPREAD_MODEL) THEN
   IF (USE_CONSTANT_BLDG_SPREAD_MODEL_PARAMS) THEN
      IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(28)) BLDG_AREA%R4            (:,:,:) = BLDG_AREA_CONSTANT
      IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(29)) BLDG_SEPARATION_DIST%R4 (:,:,:) = BLDG_SEPARATION_DIST_CONSTANT
      IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(30)) BLDG_NONBURNABLE_FRAC%R4(:,:,:) = BLDG_NONBURNABLE_FRAC_CONSTANT
      IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(31)) BLDG_FOOTPRINT_FRAC%R4  (:,:,:) = BLDG_FOOTPRINT_FRAC_CONSTANT
      IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(32)) BLDG_FUEL_MODEL%I2      (:,:,:) = BLDG_FUEL_MODEL_CONSTANT
   ELSE
      IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(28)) THEN
         FN = TRIM(FUELS_AND_TOPOGRAPHY_DIRECTORY) // TRIM(BLDG_AREA_FILENAME)
         CALL READ_BSQ_RASTER_EXISTING_TILED (BLDG_AREA,FN)
      ENDIF
      IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(29)) THEN
         FN = TRIM(FUELS_AND_TOPOGRAPHY_DIRECTORY) // TRIM(BLDG_SEPARATION_DIST_FILENAME)
         CALL READ_BSQ_RASTER_EXISTING_TILED (BLDG_SEPARATION_DIST,FN)
      ENDIF
      IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(30)) THEN
         FN = TRIM(FUELS_AND_TOPOGRAPHY_DIRECTORY) // TRIM(BLDG_NONBURNABLE_FRAC_FILENAME)
         CALL READ_BSQ_RASTER_EXISTING_TILED (BLDG_NONBURNABLE_FRAC,FN)
      ENDIF
      IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(31)) THEN
         FN = TRIM(FUELS_AND_TOPOGRAPHY_DIRECTORY) // TRIM(BLDG_FOOTPRINT_FRAC_FILENAME)
         CALL READ_BSQ_RASTER_EXISTING_TILED (BLDG_FOOTPRINT_FRAC,FN)
      ENDIF
      IF (IRANK_WORLD .EQ. PARALLEL_IO_RANK(32)) THEN
         FN = TRIM(FUELS_AND_TOPOGRAPHY_DIRECTORY) // TRIM(BLDG_FUEL_MODEL_FILENAME)
         CALL READ_BSQ_RASTER_EXISTING_TILED (BLDG_FUEL_MODEL,FN)
      ENDIF
   ENDIF
ENDIF

IF (USE_PYROMES .AND. IRANK_WORLD .EQ. PARALLEL_IO_RANK(33)) THEN
   FN = TRIM(FUELS_AND_TOPOGRAPHY_DIRECTORY) // TRIM(PYROMES_FILENAME)
   CALL READ_BSQ_RASTER_EXISTING_TILED (PYROMES,FN)
ENDIF

CALL MPI_BARRIER(MPI_COMM_WORLD, IERR)
IF (NPROC .GT. 1) THEN
   CALL MPI_BCAST_RASTER_HEADER(IGN_MASK  , PARALLEL_IO_RANK(12), .FALSE.)
   CALL MPI_BCAST_RASTER_HEADER(ASP       , PARALLEL_IO_RANK(13), .FALSE.)
   CALL MPI_BCAST_RASTER_HEADER(CBH       , PARALLEL_IO_RANK(14), .FALSE.)
   CALL MPI_BCAST_RASTER_HEADER(CBD       , PARALLEL_IO_RANK(15), .FALSE.)
   CALL MPI_BCAST_RASTER_HEADER(CC        , PARALLEL_IO_RANK(16), .FALSE.)
   CALL MPI_BCAST_RASTER_HEADER(CH        , PARALLEL_IO_RANK(17), .FALSE.)
   IF (MODE .NE. 2) CALL MPI_BCAST_RASTER_HEADER(DEM  , PARALLEL_IO_RANK(18), .FALSE.)
   CALL MPI_BCAST_RASTER_HEADER(FBFM      , PARALLEL_IO_RANK(19), .FALSE.)
   CALL MPI_BCAST_RASTER_HEADER(SLP       , PARALLEL_IO_RANK(20), .FALSE.)
   CALL MPI_BCAST_RASTER_HEADER(ADJ       , PARALLEL_IO_RANK(21), .FALSE.)
   IF (MODE .NE. 2) CALL MPI_BCAST_RASTER_HEADER(PHI0 , PARALLEL_IO_RANK(22), .FALSE.)
   IF (USE_POPULATION_DENSITY) CALL MPI_BCAST_RASTER_HEADER(POPULATION_DENSITY , PARALLEL_IO_RANK(23), .FALSE.)
   IF (USE_REAL_ESTATE_VALUE ) CALL MPI_BCAST_RASTER_HEADER(REAL_ESTATE_VALUE   ,PARALLEL_IO_RANK(24), .FALSE.)
   IF (USE_LAND_VALUE        ) CALL MPI_BCAST_RASTER_HEADER(LAND_VALUE         , PARALLEL_IO_RANK(25), .FALSE.)
   IF (USE_SDI               ) CALL MPI_BCAST_RASTER_HEADER(SDI                , PARALLEL_IO_RANK(27), .FALSE.)
   IF (USE_BLDG_SPREAD_MODEL .AND. (.NOT. USE_CONSTANT_BLDG_SPREAD_MODEL_PARAMS)) THEN
      CALL MPI_BCAST_RASTER_HEADER(BLDG_AREA            , PARALLEL_IO_RANK(28), .FALSE.)
      CALL MPI_BCAST_RASTER_HEADER(BLDG_SEPARATION_DIST , PARALLEL_IO_RANK(29), .FALSE.)
      CALL MPI_BCAST_RASTER_HEADER(BLDG_NONBURNABLE_FRAC, PARALLEL_IO_RANK(30), .FALSE.)
      CALL MPI_BCAST_RASTER_HEADER(BLDG_FOOTPRINT_FRAC  , PARALLEL_IO_RANK(31), .FALSE.)
      CALL MPI_BCAST_RASTER_HEADER(BLDG_FUEL_MODEL      , PARALLEL_IO_RANK(32), .FALSE.)
   ENDIF
   IF (USE_PYROMES) CALL MPI_BCAST_RASTER_HEADER(PYROMES, PARALLEL_IO_RANK(33), .FALSE.)
ENDIF

! *****************************************************************************
END SUBROUTINE READ_WEATHER_FUEL_TOPOGRAPHY_TILED
! *****************************************************************************

! *****************************************************************************
SUBROUTINE READ_BIL_RASTER(RASTER,FN)
! *****************************************************************************

#ifdef __INTEL_COMPILER
USE IFPORT
#endif

TYPE (RASTER_TYPE), INTENT(OUT) :: RASTER
CHARACTER(400), INTENT (IN) :: FN
CHARACTER(400) :: FNHDR, FNBIL, FNTIF, FNPRJ, FNXML, SHELLSTR
INTEGER :: I, IROW, ICOL, IOS, ICOLSTART, ICOLSTOP, IBAND, ISTAT
INTEGER*8 :: LRECL
CHARACTER(400), DIMENSION(1:14) :: BIL_HDR
REAL, ALLOCATABLE, DIMENSION(:) :: RVALUES
INTEGER*2, ALLOCATABLE, DIMENSION(:) :: I2VALUES

FNHDR = TRIM(FN) // '.hdr'
FNBIL = TRIM(FN) // '.bil'
IF (VRT_INSTEAD_OF_TIF) THEN
   FNTIF = TRIM(FN) // '.vrt'
ELSE
   FNTIF = TRIM(FN) // '.tif'
ENDIF
FNPRJ = TRIM(FN) // '.prj'
FNXML = TRIM(FNBIL) // '.aux.xml'

SHELLSTR = TRIM(PATH_TO_GDAL) // "gdal_translate -of EHdr " // TRIM(FNTIF) // " " // TRIM(FNBIL)
WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR))

!Open and parse bil header:
OPEN(LUINPUT,FILE=TRIM(FNHDR),FORM='FORMATTED',STATUS='OLD',IOSTAT=IOS) 
IF (IOS .GT. 0) THEN
   WRITE(*,*) 'Problem opening bil header file ', TRIM(FNHDR)
   CONTINUE
ENDIF

READ(LUINPUT,100,IOSTAT=IOS) BIL_HDR(01);  READ(BIL_HDR(01)(16:16),*) RASTER%BYTEORDER
READ(LUINPUT,100,IOSTAT=IOS) BIL_HDR(02);  READ(BIL_HDR(02)(16:18),*) RASTER%LAYOUT
READ(LUINPUT,100,IOSTAT=IOS) BIL_HDR(03);  READ(BIL_HDR(03)(16:30),*) RASTER%NROWS
READ(LUINPUT,100,IOSTAT=IOS) BIL_HDR(04);  READ(BIL_HDR(04)(16:30),*) RASTER%NCOLS
READ(LUINPUT,100,IOSTAT=IOS) BIL_HDR(05);  READ(BIL_HDR(05)(16:30),*) RASTER%NBANDS
READ(LUINPUT,100,IOSTAT=IOS) BIL_HDR(06);  READ(BIL_HDR(06)(16:30),*) RASTER%NBITS
READ(LUINPUT,100,IOSTAT=IOS) BIL_HDR(07);  READ(BIL_HDR(07)(16:30),*) RASTER%BANDROWBYTES
READ(LUINPUT,100,IOSTAT=IOS) BIL_HDR(08);  READ(BIL_HDR(08)(16:30),*) RASTER%TOTALROWBYTES
READ(LUINPUT,100,IOSTAT=IOS) BIL_HDR(09);  READ(BIL_HDR(09)(16:25),*) RASTER%PIXELTYPE
READ(LUINPUT,100,IOSTAT=IOS) BIL_HDR(10);  READ(BIL_HDR(10)(16:30),*) RASTER%ULXMAP
READ(LUINPUT,100,IOSTAT=IOS) BIL_HDR(11);  READ(BIL_HDR(11)(16:30),*) RASTER%ULYMAP
READ(LUINPUT,100,IOSTAT=IOS) BIL_HDR(12);  READ(BIL_HDR(12)(16:30),*) RASTER%XDIM
READ(LUINPUT,100,IOSTAT=IOS) BIL_HDR(13);  READ(BIL_HDR(13)(16:30),*) RASTER%YDIM

IF (RASTER%XDIM .NE. RASTER%YDIM) THEN
   WRITE(*,*) 'Error opening ', TRIM(FNHDR), ' because XDIM is not equal to YDIM.'
   STOP
ELSE
   RASTER%CELLSIZE=RASTER%XDIM
ENDIF

READ(LUINPUT,100,IOSTAT=IOS) BIL_HDR(14);  READ(BIL_HDR(14)(16:30),*) RASTER%NODATA_VALUE
IF (IOS .NE. 0) THEN
   WRITE(*,*) 'Error opening ', TRIM(FNHDR), ' because NODATA is not set.'
   STOP
ENDIF
CLOSE(LUINPUT,IOSTAT=IOS)

RASTER%XLLCORNER = RASTER%ULXMAP - 0.5 * RASTER%CELLSIZE
RASTER%YLLCORNER = RASTER%ULYMAP + 0.5 * RASTER%CELLSIZE - REAL(RASTER%NROWS) * RASTER%CELLSIZE 

SELECT CASE(TRIM(RASTER%PIXELTYPE))

   CASE('FLOAT')
!     Allocate arrays as appropriate:
      IF (.NOT. ASSOCIATED(RASTER%R4)) THEN
         ALLOCATE(RASTER%R4(1:RASTER%NCOLS,1:RASTER%NROWS,1:RASTER%NBANDS) )
         RASTER%R4(:,:,:) = RASTER%NODATA_VALUE
      ENDIF

      ALLOCATE(RVALUES(1:RASTER%NBANDS*RASTER%NCOLS))

!Open raster bil file:
      INQUIRE (IOLENGTH=LRECL) RVALUES(:) 

      OPEN(LUINPUT, FILE=TRIM(FNBIL), ACCESS='DIRECT', STATUS='OLD', RECL=LRECL, IOSTAT=IOS) 
      IF (IOS .GT. 0) THEN
         WRITE(*,*) 'Problem opening raster file ', TRIM(FNBIL)
         STOP
      ENDIF

      I = RASTER%NROWS + 1
      DO IROW = 1, RASTER%NROWS
         I = I - 1
         READ(LUINPUT,REC=IROW,IOSTAT=IOS) (RVALUES(ICOL) , ICOL = 1, RASTER%NBANDS*RASTER%NCOLS)
         ICOLSTART = 1
         DO IBAND = 1, RASTER%NBANDS
            ICOLSTOP = ICOLSTART + RASTER%NCOLS - 1
            RASTER%R4(1:RASTER%NCOLS,I,IBAND) = RVALUES(ICOLSTART:ICOLSTOP)
            ICOLSTART = ICOLSTOP + 1
         ENDDO
      ENDDO

      DEALLOCATE(RVALUES)

   CASE('SIGNEDINT')
!     Allocate arrays as appropriate:
      IF (.NOT. ASSOCIATED(RASTER%I2)) THEN
         ALLOCATE(RASTER%I2(1:RASTER%NCOLS,1:RASTER%NROWS,1:RASTER%NBANDS) )
         RASTER%I2(:,:,:) = NINT(RASTER%NODATA_VALUE,2)
      ENDIF

      ALLOCATE(I2VALUES(1:RASTER%NBANDS*RASTER%NCOLS))

!Open raster bil file:
      INQUIRE (IOLENGTH=LRECL) I2VALUES(:) 

      OPEN(LUINPUT, FILE=TRIM(FNBIL), ACCESS='DIRECT', STATUS='OLD', RECL=LRECL, IOSTAT=IOS) 
      IF (IOS .GT. 0) THEN
         WRITE(*,*) 'Problem opening raster file ', TRIM(FNBIL)
         STOP
      ENDIF

      I = RASTER%NROWS + 1
      DO IROW = 1, RASTER%NROWS
         I = I - 1
         READ(LUINPUT,REC=IROW,IOSTAT=IOS) (I2VALUES(ICOL) , ICOL = 1, RASTER%NBANDS*RASTER%NCOLS)
         ICOLSTART = 1
         DO IBAND = 1, RASTER%NBANDS
            ICOLSTOP = ICOLSTART + RASTER%NCOLS - 1
            RASTER%I2(1:RASTER%NCOLS,I,IBAND) = I2VALUES(ICOLSTART:ICOLSTOP)
            ICOLSTART = ICOLSTOP + 1
         ENDDO
      ENDDO

      DEALLOCATE(I2VALUES)

   CASE DEFAULT
      CONTINUE

END SELECT

CLOSE(LUINPUT,IOSTAT=IOS)

SHELLSTR = TRIM(DELETECOMMAND) // " " // TRIM(FNBIL); WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR))
SHELLSTR = TRIM(DELETECOMMAND) // " " // TRIM(FNHDR); WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR))
SHELLSTR = TRIM(DELETECOMMAND) // " " // TRIM(FNPRJ); WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR))
SHELLSTR = TRIM(DELETECOMMAND) // " " // TRIM(FNXML); WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR))

100 FORMAT(A)

! *****************************************************************************
END SUBROUTINE READ_BIL_RASTER
! *****************************************************************************

! *****************************************************************************
SUBROUTINE WRITE_BIL_RASTER(RASTER, INDIR, STUB, CONVERT_TO_GEOTIFF_LOCAL, COMPRESS)
! *****************************************************************************

#ifdef __INTEL_COMPILER
USE IFPORT
#endif

TYPE (RASTER_TYPE), INTENT(IN) :: RASTER
CHARACTER(400), INTENT(IN) :: INDIR, STUB
LOGICAL, INTENT(IN) :: CONVERT_TO_GEOTIFF_LOCAL,COMPRESS
CHARACTER(400) :: SHELLSTR,FNBIL,FNHDR,FNTIF
INTEGER :: IOS, IROW, ICOL, IBAND, ISTAT
REAL, ALLOCATABLE, DIMENSION(:) ::  RVALUES
INTEGER           :: ICOLSTART, ICOLSTOP, IROWSTART, IROWSTOP, IREC
INTEGER*8 :: LRECL
INTEGER*2, ALLOCATABLE, DIMENSION(:) :: I2VALUES

IF (TRIM(SCRATCH) .EQ. 'null') THEN
   FNTIF = TRIM(INDIR) // TRIM(STUB) // '.tif'
   FNHDR = TRIM(INDIR) // TRIM(STUB) // '.hdr'
   FNBIL = TRIM(INDIR) // TRIM(STUB) // '.bil'
ELSE
   FNTIF = TRIM(INDIR  ) // TRIM(STUB) // '.tif'
   FNHDR = TRIM(SCRATCH) // TRIM(STUB) // '.hdr'
   FNBIL = TRIM(SCRATCH) // TRIM(STUB) // '.bil'
ENDIF

IF (.NOT. CONVERT_TO_GEOTIFF_LOCAL) THEN
   FNHDR = TRIM(INDIR  ) // TRIM(STUB) // '.hdr'
   FNBIL = TRIM(INDIR  ) // TRIM(STUB) // '.bil'
ENDIF

ICOLSTART  = 1 
ICOLSTOP   = RASTER%NCOLS
IROWSTART  = 1
IROWSTOP   = RASTER%NROWS

!Open and write hdr file:
OPEN(LUOUTPUT,FILE=TRIM(FNHDR),FORM='FORMATTED',STATUS='REPLACE',IOSTAT=IOS)

WRITE(LUOUTPUT,110,IOSTAT=IOS) 'BYTEORDER      ', TRIM(RASTER%BYTEORDER)
WRITE(LUOUTPUT,110,IOSTAT=IOS) 'LAYOUT         ', TRIM(RASTER%LAYOUT)
WRITE(LUOUTPUT,300,IOSTAT=IOS) 'NROWS          ', RASTER%NROWS 
WRITE(LUOUTPUT,300,IOSTAT=IOS) 'NCOLS          ', RASTER%NCOLS
WRITE(LUOUTPUT,300,IOSTAT=IOS) 'NBANDS         ', RASTER%NBANDS
WRITE(LUOUTPUT,300,IOSTAT=IOS) 'NBITS          ', RASTER%NBITS
WRITE(LUOUTPUT,300,IOSTAT=IOS) 'BANDROWBYTES   ', RASTER%BANDROWBYTES  !4*RASTER%NCOLS
WRITE(LUOUTPUT,300,IOSTAT=IOS) 'TOTALROWBYTES  ', RASTER%TOTALROWBYTES !4*RASTER%NBANDS*RASTER%NCOLS 
WRITE(LUOUTPUT,110,IOSTAT=IOS) 'PIXELTYPE      ', TRIM(RASTER%PIXELTYPE)
WRITE(LUOUTPUT,400,IOSTAT=IOS) 'ULXMAP         ', RASTER%ULXMAP
WRITE(LUOUTPUT,400,IOSTAT=IOS) 'ULYMAP         ', RASTER%ULYMAP
WRITE(LUOUTPUT,400,IOSTAT=IOS) 'XDIM           ', RASTER%CELLSIZE
WRITE(LUOUTPUT,400,IOSTAT=IOS) 'YDIM           ', RASTER%CELLSIZE
WRITE(LUOUTPUT,400,IOSTAT=IOS) 'NODATA         ', RASTER%NODATA_VALUE
CLOSE(LUOUTPUT,IOSTAT=IOS)

!Open and write raster file:

SELECT CASE (TRIM(RASTER%PIXELTYPE))

   CASE ('FLOAT') 

      ALLOCATE(RVALUES(1:RASTER%NCOLS*RASTER%NBANDS))

      INQUIRE (IOLENGTH=LRECL) RVALUES(:)
      OPEN(LUOUTPUT,FILE=TRIM(FNBIL),ACCESS='DIRECT',STATUS='REPLACE',RECL=LRECL,IOSTAT=IOS) 
      IF (IOS .GT. 0) THEN
         WRITE(*,*) 'Problem opening output bil file ', TRIM(FNBIL)
         STOP
      ENDIF

      IREC = 0
      DO IROW = IROWSTOP, IROWSTART, -1

         IREC = IREC + 1
         RVALUES(:) = REAL(RASTER%NODATA_VALUE)
   
         ICOLSTART = 1
         DO IBAND = 1, RASTER%NBANDS
            ICOLSTOP  = ICOLSTART + RASTER%NCOLS - 1
            RVALUES(ICOLSTART:ICOLSTOP) = RASTER%R4(1:RASTER%NCOLS,IROW,IBAND)   
            ICOLSTART = ICOLSTOP + 1
         ENDDO
   
         WRITE(LUOUTPUT,REC=IREC,IOSTAT=IOS) (RVALUES(ICOL), ICOL=1, ICOLSTOP)
   
      ENDDO

      FLUSH(LUOUTPUT)
      CLOSE(LUOUTPUT,IOSTAT=IOS)

      DEALLOCATE(RVALUES)

      IF (CONVERT_TO_GEOTIFF_LOCAL) THEN
         IF (COMPRESS) THEN
            SHELLSTR = TRIM(PATH_TO_GDAL) // 'gdal_translate -ot Float32 -co "COMPRESS=DEFLATE" -co "ZLEVEL=9" -a_srs "' // &
                       TRIM(A_SRS) // '" ' // TRIM(FNBIL) // ' ' // TRIM(FNTIF)
            WRITE(*,100) TRIM(SHELLSTR)
            ISTAT = SYSTEM(TRIM(SHELLSTR))
         ELSE
            SHELLSTR = TRIM(PATH_TO_GDAL) // 'gdal_translate -ot Float32 -a_srs "' // &
                       TRIM(A_SRS) // '" ' // TRIM(FNBIL) // ' '// TRIM(FNTIF)
            WRITE(*,100) TRIM(SHELLSTR)
            ISTAT = SYSTEM(TRIM(SHELLSTR))
         ENDIF

         SHELLSTR = TRIM(DELETECOMMAND) // " " // TRIM(FNBIL); WRITE(*,100) TRIM(SHELLSTR)
         ISTAT = SYSTEM(TRIM(SHELLSTR))

         SHELLSTR = TRIM(DELETECOMMAND) // " " // TRIM(FNHDR); WRITE(*,100) TRIM(SHELLSTR)
         ISTAT = SYSTEM(TRIM(SHELLSTR))

      ENDIF

   CASE ('SIGNEDINT') 

      ALLOCATE(I2VALUES(1:RASTER%NCOLS*RASTER%NBANDS))

      INQUIRE (IOLENGTH = LRECL) I2VALUES(:)
      OPEN(LUOUTPUT,FILE=TRIM(FNBIL),ACCESS='DIRECT',STATUS='REPLACE',RECL=LRECL,IOSTAT=IOS) 
      IF (IOS .GT. 0) THEN
         WRITE(*,*) 'Problem opening output bil file ', TRIM(FNBIL)
         STOP
      ENDIF

      IREC = 0
      DO IROW = IROWSTOP, IROWSTART, -1

         IREC = IREC + 1
         I2VALUES(:) = NINT(RASTER%NODATA_VALUE,2)
   
         ICOLSTART = 1
         DO IBAND = 1, RASTER%NBANDS
            ICOLSTOP  = ICOLSTART + RASTER%NCOLS - 1
            I2VALUES(ICOLSTART:ICOLSTOP) = RASTER%I2(1:RASTER%NCOLS,IROW,IBAND)   
            ICOLSTART = ICOLSTOP + 1
         ENDDO
   
         WRITE(LUOUTPUT,REC=IREC,IOSTAT=IOS) (I2VALUES(ICOL), ICOL=1, ICOLSTOP)
   
      ENDDO

      FLUSH(LUOUTPUT)

      CLOSE(LUOUTPUT,IOSTAT=IOS)

      DEALLOCATE(I2VALUES)

      IF (CONVERT_TO_GEOTIFF_LOCAL) THEN
         IF (COMPRESS) THEN
            SHELLSTR = TRIM(PATH_TO_GDAL) // 'gdal_translate -ot Int16 -co "COMPRESS=DEFLATE" -co "ZLEVEL=9" -a_srs "' // &
                       TRIM(A_SRS) // '" ' // TRIM(FNBIL) // ' ' // TRIM(FNTIF)
            WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR))
         ELSE
            SHELLSTR = TRIM(PATH_TO_GDAL) // 'gdal_translate -ot Int16 -a_srs "' // &
                       TRIM(A_SRS) // '" ' // TRIM(FNBIL) // ' ' // TRIM(FNTIF)
            WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR))   
         ENDIF

         SHELLSTR = TRIM(DELETECOMMAND) // " " // TRIM(FNBIL); WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR))
         SHELLSTR = TRIM(DELETECOMMAND) // " " // TRIM(FNHDR); WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR))
      ENDIF

   CASE DEFAULT
      CONTINUE

END SELECT

100 FORMAT(A)
110 FORMAT(A,A)

300 FORMAT(A, I8)
400 FORMAT(A, F12.2)

! *****************************************************************************
END SUBROUTINE WRITE_BIL_RASTER
! *****************************************************************************

! *****************************************************************************
RECURSIVE SUBROUTINE WRITE_BIL_RASTER_THREADSAFE(RASTER, INDIR, STUB, CONVERT_TO_GEOTIFF_LOCAL, COMPRESS, THREADNUM)
! *****************************************************************************

#ifdef __INTEL_COMPILER
USE IFPORT
#endif

TYPE (RASTER_TYPE), INTENT(IN) :: RASTER
CHARACTER(400), INTENT(IN) :: INDIR,STUB
LOGICAL, INTENT(IN) :: CONVERT_TO_GEOTIFF_LOCAL,COMPRESS
INTEGER, INTENT(IN) :: THREADNUM
CHARACTER(400) :: SHELLSTR,FNBIL,FNHDR,FNTIF
INTEGER :: IOS, IROW, ICOL, IBAND, ISTAT, LUOUT
REAL, ALLOCATABLE, DIMENSION(:) ::  RVALUES
INTEGER :: ICOLSTART, ICOLSTOP, IROWSTART, IROWSTOP, IREC
INTEGER*8 :: LRECL
INTEGER*2, ALLOCATABLE, DIMENSION(:) :: I2VALUES

LUOUT = LUOUTPUT + THREADNUM

IF (TRIM(SCRATCH) .EQ. 'null') THEN
   FNTIF = TRIM(INDIR) // TRIM(STUB) // '.tif'
   FNHDR = TRIM(INDIR) // TRIM(STUB) // '.hdr'
   FNBIL = TRIM(INDIR) // TRIM(STUB) // '.bil'
ELSE
   FNTIF = TRIM(INDIR  ) // TRIM(STUB) // '.tif'
   FNHDR = TRIM(SCRATCH) // TRIM(STUB) // '.hdr'
   FNBIL = TRIM(SCRATCH) // TRIM(STUB) // '.bil'
ENDIF

IF (.NOT. CONVERT_TO_GEOTIFF_LOCAL) THEN
   FNHDR = TRIM(INDIR  ) // TRIM(STUB) // '.hdr'
   FNBIL = TRIM(INDIR  ) // TRIM(STUB) // '.bil'
ENDIF

ICOLSTART  = 1 
ICOLSTOP   = RASTER%NCOLS
IROWSTART  = 1
IROWSTOP   = RASTER%NROWS

!Open and write hdr file:
OPEN(LUOUT,FILE=TRIM(FNHDR),FORM='FORMATTED',STATUS='REPLACE',IOSTAT=IOS)

WRITE(LUOUT,110,IOSTAT=IOS) 'BYTEORDER      ', TRIM(RASTER%BYTEORDER)
WRITE(LUOUT,110,IOSTAT=IOS) 'LAYOUT         ', TRIM(RASTER%LAYOUT)
WRITE(LUOUT,300,IOSTAT=IOS) 'NROWS          ', RASTER%NROWS 
WRITE(LUOUT,300,IOSTAT=IOS) 'NCOLS          ', RASTER%NCOLS
WRITE(LUOUT,300,IOSTAT=IOS) 'NBANDS         ', RASTER%NBANDS
WRITE(LUOUT,300,IOSTAT=IOS) 'NBITS          ', RASTER%NBITS
WRITE(LUOUT,300,IOSTAT=IOS) 'BANDROWBYTES   ', RASTER%BANDROWBYTES  !4*RASTER%NCOLS
WRITE(LUOUT,300,IOSTAT=IOS) 'TOTALROWBYTES  ', RASTER%TOTALROWBYTES !4*RASTER%NBANDS*RASTER%NCOLS 
WRITE(LUOUT,110,IOSTAT=IOS) 'PIXELTYPE      ', TRIM(RASTER%PIXELTYPE)
WRITE(LUOUT,400,IOSTAT=IOS) 'ULXMAP         ', RASTER%ULXMAP
WRITE(LUOUT,400,IOSTAT=IOS) 'ULYMAP         ', RASTER%ULYMAP
WRITE(LUOUT,400,IOSTAT=IOS) 'XDIM           ', RASTER%CELLSIZE
WRITE(LUOUT,400,IOSTAT=IOS) 'YDIM           ', RASTER%CELLSIZE
WRITE(LUOUT,400,IOSTAT=IOS) 'NODATA         ', RASTER%NODATA_VALUE
CLOSE(LUOUT,IOSTAT=IOS)

!Open and write raster file:

SELECT CASE (TRIM(RASTER%PIXELTYPE))

   CASE ('FLOAT') 

      ALLOCATE(RVALUES(1:RASTER%NCOLS*RASTER%NBANDS))

      INQUIRE (IOLENGTH=LRECL) RVALUES(:)
      OPEN(LUOUT,FILE=TRIM(FNBIL),ACCESS='DIRECT',STATUS='REPLACE',RECL=LRECL,IOSTAT=IOS) 
      IF (IOS .GT. 0) THEN
         WRITE(*,*) 'Problem opening output bil file ', TRIM(FNBIL)
         STOP
      ENDIF

      IREC = 0
      DO IROW = IROWSTOP, IROWSTART, -1

         IREC = IREC + 1
         RVALUES(:) = REAL(RASTER%NODATA_VALUE)
   
         ICOLSTART = 1
         DO IBAND = 1, RASTER%NBANDS
            ICOLSTOP  = ICOLSTART + RASTER%NCOLS - 1
            RVALUES(ICOLSTART:ICOLSTOP) = RASTER%R4(1:RASTER%NCOLS,IROW,IBAND)   
            ICOLSTART = ICOLSTOP + 1
         ENDDO
   
         WRITE(LUOUT,REC=IREC,IOSTAT=IOS) (RVALUES(ICOL), ICOL=1, ICOLSTOP)
   
      ENDDO

!      FLUSH(LUOUT)
      CLOSE(LUOUT,IOSTAT=IOS)

      DEALLOCATE(RVALUES)

      IF (CONVERT_TO_GEOTIFF_LOCAL) THEN
         IF (COMPRESS) THEN
            SHELLSTR = TRIM(PATH_TO_GDAL) // 'gdal_translate -ot Float32 -co "COMPRESS=DEFLATE" -co "ZLEVEL=9" -a_srs "' // &
                       TRIM(A_SRS) // '" ' // TRIM(FNBIL) // ' ' // TRIM(FNTIF)
            WRITE(*,100) TRIM(SHELLSTR)
            ISTAT = SYSTEM(TRIM(SHELLSTR))
         ELSE
            SHELLSTR = TRIM(PATH_TO_GDAL) // 'gdal_translate -ot Float32 -a_srs "' // &
                       TRIM(A_SRS) // '" ' // TRIM(FNBIL) // ' '// TRIM(FNTIF)
            WRITE(*,100) TRIM(SHELLSTR)
            ISTAT = SYSTEM(TRIM(SHELLSTR))
         ENDIF

         SHELLSTR = TRIM(DELETECOMMAND) // " " // TRIM(FNBIL); WRITE(*,100) TRIM(SHELLSTR)
         ISTAT = SYSTEM(TRIM(SHELLSTR))

         SHELLSTR = TRIM(DELETECOMMAND) // " " // TRIM(FNHDR); WRITE(*,100) TRIM(SHELLSTR)
         ISTAT = SYSTEM(TRIM(SHELLSTR))

      ENDIF

   CASE ('SIGNEDINT') 

      ALLOCATE(I2VALUES(1:RASTER%NCOLS*RASTER%NBANDS))

      INQUIRE (IOLENGTH = LRECL) I2VALUES(:)
      OPEN(LUOUT,FILE=TRIM(FNBIL),ACCESS='DIRECT',STATUS='REPLACE',RECL=LRECL,IOSTAT=IOS) 
      IF (IOS .GT. 0) THEN
         WRITE(*,*) 'Problem opening output bil file ', TRIM(FNBIL)
         STOP
      ENDIF

      IREC = 0
      DO IROW = IROWSTOP, IROWSTART, -1

         IREC = IREC + 1
         I2VALUES(:) = NINT(RASTER%NODATA_VALUE,2)
   
         ICOLSTART = 1
         DO IBAND = 1, RASTER%NBANDS
            ICOLSTOP  = ICOLSTART + RASTER%NCOLS - 1
            I2VALUES(ICOLSTART:ICOLSTOP) = RASTER%I2(1:RASTER%NCOLS,IROW,IBAND)   
            ICOLSTART = ICOLSTOP + 1
         ENDDO
   
         WRITE(LUOUT,REC=IREC,IOSTAT=IOS) (I2VALUES(ICOL), ICOL=1, ICOLSTOP)
   
      ENDDO

      CLOSE(LUOUT,IOSTAT=IOS)

      DEALLOCATE(I2VALUES)

      IF (CONVERT_TO_GEOTIFF_LOCAL) THEN
         IF (COMPRESS) THEN
            SHELLSTR = TRIM(PATH_TO_GDAL) // 'gdal_translate -ot Int16 -co "COMPRESS=DEFLATE" -co "ZLEVEL=9" -a_srs "' // &
                       TRIM(A_SRS) // '" ' // TRIM(FNBIL) // ' ' // TRIM(FNTIF)
            WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR))
         ELSE
            SHELLSTR = TRIM(PATH_TO_GDAL) // 'gdal_translate -ot Int16 -a_srs "' // &
                       TRIM(A_SRS) // '" ' // TRIM(FNBIL) // ' ' // TRIM(FNTIF)
            WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR))   
         ENDIF

         SHELLSTR = TRIM(DELETECOMMAND) // " " // TRIM(FNBIL); WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR))
         SHELLSTR = TRIM(DELETECOMMAND) // " " // TRIM(FNHDR); WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR))
      ENDIF

   CASE DEFAULT
      WRITE(*,*) 'DEFAULT SO NOTHING HAPPENS'
      CONTINUE

END SELECT

100 FORMAT(A)
110 FORMAT(A,A)

300 FORMAT(A, I8)
400 FORMAT(A, F12.2)

! *****************************************************************************
END SUBROUTINE WRITE_BIL_RASTER_THREADSAFE
! *****************************************************************************

! *****************************************************************************
SUBROUTINE WRITE_BIL_RASTER_ONEBAND(RASTER, INDIR, STUB, CONVERT_TO_GEOTIFF_LOCAL, COMPRESS)
! *****************************************************************************

#ifdef __INTEL_COMPILER
USE IFPORT
#endif

TYPE (RASTER_TYPE), INTENT(IN) :: RASTER
CHARACTER(400), INTENT(IN) :: INDIR,STUB
LOGICAL, INTENT(IN) :: CONVERT_TO_GEOTIFF_LOCAL,COMPRESS
CHARACTER(400) :: SHELLSTR,FNBIL,FNHDR,FNTIF
INTEGER :: IOS, IROW, ICOL, IBAND, ISTAT
REAL, ALLOCATABLE, DIMENSION(:) ::  RVALUES
INTEGER           :: ICOLSTART, ICOLSTOP, IROWSTART, IROWSTOP, IREC
INTEGER*8 :: LRECL
INTEGER*2, ALLOCATABLE, DIMENSION(:) :: I2VALUES

IF (TRIM(SCRATCH) .EQ. 'null') THEN
   FNTIF = TRIM(INDIR) // TRIM(STUB) // '.tif'
   FNHDR = TRIM(INDIR) // TRIM(STUB) // '.hdr'
   FNBIL = TRIM(INDIR) // TRIM(STUB) // '.bil'
ELSE
   FNTIF = TRIM(INDIR  ) // TRIM(STUB) // '.tif'
   FNHDR = TRIM(SCRATCH) // TRIM(STUB) // '.hdr'
   FNBIL = TRIM(SCRATCH) // TRIM(STUB) // '.bil'
ENDIF

IF (.NOT. CONVERT_TO_GEOTIFF_LOCAL) THEN
   FNHDR = TRIM(INDIR  ) // TRIM(STUB) // '.hdr'
   FNBIL = TRIM(INDIR  ) // TRIM(STUB) // '.bil'
ENDIF

ICOLSTART  = 1 
ICOLSTOP   = RASTER%NCOLS
IROWSTART  = 1
IROWSTOP   = RASTER%NROWS

!Open and write hdr file:
OPEN(LUOUTPUT,FILE=TRIM(FNHDR),FORM='FORMATTED',STATUS='REPLACE',IOSTAT=IOS)

WRITE(LUOUTPUT,110,IOSTAT=IOS) 'BYTEORDER      ', TRIM(RASTER%BYTEORDER)
WRITE(LUOUTPUT,110,IOSTAT=IOS) 'LAYOUT         ', TRIM(RASTER%LAYOUT)
WRITE(LUOUTPUT,300,IOSTAT=IOS) 'NROWS          ', RASTER%NROWS 
WRITE(LUOUTPUT,300,IOSTAT=IOS) 'NCOLS          ', RASTER%NCOLS
WRITE(LUOUTPUT,300,IOSTAT=IOS) 'NBANDS         ', 1
WRITE(LUOUTPUT,300,IOSTAT=IOS) 'NBITS          ', RASTER%NBITS
WRITE(LUOUTPUT,300,IOSTAT=IOS) 'BANDROWBYTES   ', RASTER%BANDROWBYTES  !4*RASTER%NCOLS
WRITE(LUOUTPUT,300,IOSTAT=IOS) 'TOTALROWBYTES  ', RASTER%TOTALROWBYTES !4*RASTER%NBANDS*RASTER%NCOLS 
WRITE(LUOUTPUT,110,IOSTAT=IOS) 'PIXELTYPE      ', TRIM(RASTER%PIXELTYPE)
WRITE(LUOUTPUT,400,IOSTAT=IOS) 'ULXMAP         ', RASTER%ULXMAP
WRITE(LUOUTPUT,400,IOSTAT=IOS) 'ULYMAP         ', RASTER%ULYMAP
WRITE(LUOUTPUT,400,IOSTAT=IOS) 'XDIM           ', RASTER%CELLSIZE
WRITE(LUOUTPUT,400,IOSTAT=IOS) 'YDIM           ', RASTER%CELLSIZE
WRITE(LUOUTPUT,400,IOSTAT=IOS) 'NODATA         ', RASTER%NODATA_VALUE
CLOSE(LUOUTPUT,IOSTAT=IOS)

!Open and write raster file:

SELECT CASE (TRIM(RASTER%PIXELTYPE))

   CASE ('FLOAT') 

      ALLOCATE(RVALUES(1:RASTER%NCOLS*1))

      INQUIRE (IOLENGTH=LRECL) RVALUES(:)
      OPEN(LUOUTPUT,FILE=TRIM(FNBIL),ACCESS='DIRECT',STATUS='REPLACE',RECL=LRECL,IOSTAT=IOS) 
      IF (IOS .GT. 0) THEN
         WRITE(*,*) 'Problem opening output bil file ', TRIM(FNBIL)
         STOP
      ENDIF

      IREC = 0
      DO IROW = IROWSTOP, IROWSTART, -1

         IREC = IREC + 1
         RVALUES(:) = REAL(RASTER%NODATA_VALUE)
   
         ICOLSTART = 1
         IBAND = 1
         ICOLSTOP  = ICOLSTART + RASTER%NCOLS - 1
         RVALUES(ICOLSTART:ICOLSTOP) = RASTER%R4(1:RASTER%NCOLS,IROW,IBAND)   
         ICOLSTART = ICOLSTOP + 1
   
         WRITE(LUOUTPUT,REC=IREC,IOSTAT=IOS) (RVALUES(ICOL), ICOL=1, ICOLSTOP)
   
      ENDDO

      FLUSH(LUOUTPUT)
      CLOSE(LUOUTPUT,IOSTAT=IOS)

      DEALLOCATE(RVALUES)

      IF (CONVERT_TO_GEOTIFF_LOCAL) THEN
         IF (COMPRESS) THEN

            SHELLSTR = TRIM(PATH_TO_GDAL) // 'gdal_translate -ot Float32 -co "COMPRESS=DEFLATE" -co "ZLEVEL=9" -a_srs "' // &
                       TRIM(A_SRS) // '" ' // TRIM(FNBIL) // ' ' // TRIM(FNTIF)
            WRITE(*,100) TRIM(SHELLSTR)
            ISTAT = SYSTEM(TRIM(SHELLSTR))
         ELSE
            SHELLSTR = TRIM(PATH_TO_GDAL) // 'gdal_translate -ot Float32 -a_srs "' // &
                       TRIM(A_SRS) // '" ' // TRIM(FNBIL) // ' '// TRIM(FNTIF)
            WRITE(*,100) TRIM(SHELLSTR)
            ISTAT = SYSTEM(TRIM(SHELLSTR))
         ENDIF

         SHELLSTR = TRIM(DELETECOMMAND) // " " // TRIM(FNBIL); WRITE(*,100) TRIM(SHELLSTR)
         ISTAT = SYSTEM(TRIM(SHELLSTR))

         SHELLSTR = TRIM(DELETECOMMAND) // " " // TRIM(FNHDR); WRITE(*,100) TRIM(SHELLSTR)
         ISTAT = SYSTEM(TRIM(SHELLSTR))

      ENDIF

   CASE ('SIGNEDINT') 

      ALLOCATE(I2VALUES(1:RASTER%NCOLS*RASTER%NBANDS))

      INQUIRE (IOLENGTH = LRECL) I2VALUES(:)
      OPEN(LUOUTPUT,FILE=TRIM(FNBIL),ACCESS='DIRECT',STATUS='REPLACE',RECL=LRECL,IOSTAT=IOS) 
      IF (IOS .GT. 0) THEN
         WRITE(*,*) 'Problem opening output bil file ', TRIM(FNBIL)
         STOP
      ENDIF

      IREC = 0
      DO IROW = IROWSTOP, IROWSTART, -1

         IREC = IREC + 1
         I2VALUES(:) = NINT(RASTER%NODATA_VALUE,2)
   
         ICOLSTART = 1
         IBAND = 1
         ICOLSTOP  = ICOLSTART + RASTER%NCOLS - 1
         I2VALUES(ICOLSTART:ICOLSTOP) = RASTER%I2(1:RASTER%NCOLS,IROW,IBAND)   
         ICOLSTART = ICOLSTOP + 1
   
         WRITE(LUOUTPUT,REC=IREC,IOSTAT=IOS) (I2VALUES(ICOL), ICOL=1, ICOLSTOP)
   
      ENDDO

      FLUSH(LUOUTPUT)

      CLOSE(LUOUTPUT,IOSTAT=IOS)

      DEALLOCATE(I2VALUES)

      IF (CONVERT_TO_GEOTIFF_LOCAL) THEN
         IF (COMPRESS) THEN
            SHELLSTR = TRIM(PATH_TO_GDAL) // 'gdal_translate -ot Int16 -co "COMPRESS=DEFLATE" -co "ZLEVEL=9" -a_srs "' // &
                       TRIM(A_SRS) // '" ' // TRIM(FNBIL) // ' ' // TRIM(FNTIF)
            WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR))
         ELSE
            SHELLSTR = TRIM(PATH_TO_GDAL) // 'gdal_translate -ot Int16 -a_srs "' // &
                       TRIM(A_SRS) // '" ' // TRIM(FNBIL) // ' ' // TRIM(FNTIF)
            WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR))   
         ENDIF

         SHELLSTR = TRIM(DELETECOMMAND) // " " // TRIM(FNBIL); WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR))
         SHELLSTR = TRIM(DELETECOMMAND) // " " // TRIM(FNHDR); WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR))
      ENDIF

   CASE DEFAULT
      CONTINUE

END SELECT

100 FORMAT(A)
110 FORMAT(A,A)

300 FORMAT(A, I8)
400 FORMAT(A, F12.2)

! *****************************************************************************
END SUBROUTINE WRITE_BIL_RASTER_ONEBAND
! *****************************************************************************

! *****************************************************************************
SUBROUTINE READ_BSQ_HEADER(RASTER,INDIR,FN,DELETE_INTERMEDIATE_FILES)
! *****************************************************************************

#ifdef __INTEL_COMPILER
USE IFPORT
#endif

TYPE (RASTER_TYPE) :: RASTER
CHARACTER(400), INTENT (IN) :: INDIR,FN
LOGICAL, INTENT(IN) :: DELETE_INTERMEDIATE_FILES
CHARACTER(400) :: FNHDR, FNBSQ, FNTIF, FNPRJ, FNXML, SHELLSTR, TEMPSTR
INTEGER :: I, IOS, ISTAT, ITYPE

IF (VRT_INSTEAD_OF_TIF) THEN
   FNTIF = TRIM(INDIR) // TRIM(FN) // '.vrt'
ELSE
   FNTIF = TRIM(INDIR) // TRIM(FN) // '.tif'
ENDIF

IF (TRIM(SCRATCH) .EQ. 'null') THEN
   FNHDR = TRIM(INDIR) // TRIM(FN) // '.hdr'
   FNBSQ = TRIM(INDIR) // TRIM(FN) // '.bsq'
   FNPRJ = TRIM(INDIR) // TRIM(FN) // '.prj'
   FNXML = TRIM(FNBSQ) // '.aux.xml'
ELSE
   FNHDR = TRIM(SCRATCH) // TRIM(FN) // '.hdr'
   FNBSQ = TRIM(SCRATCH) // TRIM(FN) // '.bsq'
   FNPRJ = TRIM(SCRATCH) // TRIM(FN) // '.prj'
   FNXML = TRIM(FNBSQ) // '.aux.xml'
ENDIF

! Convert to ENVI header BSQ format
IF (.NOT. USE_EXISTING_BSQS) THEN
   SHELLSTR = TRIM(PATH_TO_GDAL) // 'gdal_translate -of ENVI -co "INTERLEAVE=BSQ" ' // TRIM(FNTIF) // " " // TRIM(FNBSQ)
   WRITE(*,100) TRIM(SHELLSTR); CALL EXECUTE_COMMAND_LINE(TRIM(SHELLSTR))
ENDIF

! Open and parse BSQ XML:
OPEN(LUINPUT,FILE=TRIM(FNXML),FORM='FORMATTED',STATUS='OLD',IOSTAT=IOS) 
IF (IOS .GT. 0) THEN
   WRITE(*,*) 'Problem opening bsq xml header ', TRIM(FNXML)
   WRITE(*,*) 'IOS: ', IOS
   STOP
ENDIF

! Trash first five lines
DO I = 1, 5
   READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
   CONTINUE
ENDDO

! Read number of bands:
READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
READ(TEMPSTR(22:30),*) TEMPSTR
TEMPSTR=TEMPSTR(1:LEN_TRIM(TEMPSTR)-1)
READ(TEMPSTR,*,IOSTAT=IOS) RASTER%NBANDS

IF (IOS .NE. 0) THEN
   RASTER%NBANDS=1
ENDIF

! Skip over byte order:
READ(LUINPUT,100,IOSTAT=IOS)

! Read data type
READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
READ(TEMPSTR(26:26),*) TEMPSTR
READ(TEMPSTR,*) ITYPE
IF (ITYPE .EQ. 2) THEN
   RASTER%PIXELTYPE='SIGNEDINT'
   RASTER%NBITS=16
ENDIF
IF (ITYPE .EQ. 4) THEN
   RASTER%PIXELTYPE='FLOAT'
   RASTER%NBITS=32
ENDIF

! Skip 3 more lines
DO I = 1, 3
   READ(LUINPUT,100,IOSTAT=IOS)
ENDDO

! Read number of rows:
READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
READ(TEMPSTR(22:30),*) TEMPSTR
TEMPSTR=TEMPSTR(1:LEN_TRIM(TEMPSTR)-1)
READ(TEMPSTR,*) RASTER%NROWS

! Read number of columns:
READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
READ(TEMPSTR(24:32),*) TEMPSTR
TEMPSTR=TEMPSTR(1:LEN_TRIM(TEMPSTR)-1)
READ(TEMPSTR,*) RASTER%NCOLS

CLOSE(LUINPUT,IOSTAT=IOS)

IF (DELETE_INTERMEDIATE_FILES) THEN
   SHELLSTR = TRIM(DELETECOMMAND) // " " // TRIM(FNBSQ) // " " // TRIM(FNHDR) // " " // TRIM(FNPRJ) // " " // TRIM(FNXML)
   WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR))
ENDIF

100 FORMAT(A)

! *****************************************************************************
END SUBROUTINE READ_BSQ_HEADER
! *****************************************************************************

! *****************************************************************************
SUBROUTINE READ_BSQ_HEADER_EXISTING_TILED(RASTER,FNIN)
! *****************************************************************************

#ifdef __INTEL_COMPILER
USE IFPORT
#endif

TYPE (RASTER_TYPE), INTENT(OUT) :: RASTER
CHARACTER(400), INTENT (IN) :: FNIN
CHARACTER(400) :: FNHDR, FNBSQ, FNXML, TEMPSTR
INTEGER :: I, IOS, ITYPE, ITILE, JTILE
CHARACTER(1), DIMENSION(1:3), PARAMETER :: CINDEX = (/'1', '2', '3'/)

ITILE = 1
JTILE = 1

FNHDR = TRIM(FNIN) // '_' // CINDEX(ITILE) // '_' // CINDEX(JTILE) // '.hdr'
FNBSQ = TRIM(FNIN) // '_' // CINDEX(ITILE) // '_' // CINDEX(JTILE) // '.bsq'
FNXML = TRIM(FNBSQ) // '.aux.xml'

! Open and parse BSQ XML:
OPEN(LUINPUT,FILE=TRIM(FNXML),FORM='FORMATTED',STATUS='OLD',IOSTAT=IOS) 
IF (IOS .GT. 0) THEN
   WRITE(*,*) 'Problem opening bsq xml header ', TRIM(FNXML)
   WRITE(*,*) 'IOS: ', IOS
   STOP
ENDIF

! Trash first five lines
DO I = 1, 5
   READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
   CONTINUE
ENDDO

! Read number of bands:
READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
READ(TEMPSTR(22:30),*) TEMPSTR
TEMPSTR=TEMPSTR(1:LEN_TRIM(TEMPSTR)-1)
READ(TEMPSTR,*,IOSTAT=IOS) RASTER%NBANDS

IF (IOS .NE. 0) RASTER%NBANDS=1

! Skip over byte order:
READ(LUINPUT,100,IOSTAT=IOS)

! Read data type
READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
READ(TEMPSTR(26:26),*) TEMPSTR
READ(TEMPSTR,*) ITYPE
IF (ITYPE .EQ. 2) THEN
   RASTER%PIXELTYPE='SIGNEDINT'
   RASTER%NBITS=16
ENDIF
IF (ITYPE .EQ. 4) THEN
   RASTER%PIXELTYPE='FLOAT'
   RASTER%NBITS=32
ENDIF

! Skip 3 more lines
DO I = 1, 3
   READ(LUINPUT,100,IOSTAT=IOS)
ENDDO

! Read number of rows:
READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
READ(TEMPSTR(22:30),*) TEMPSTR
TEMPSTR=TEMPSTR(1:LEN_TRIM(TEMPSTR)-1)
READ(TEMPSTR,*) RASTER%NROWS

! Read number of columns:
READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
READ(TEMPSTR(24:32),*) TEMPSTR
TEMPSTR=TEMPSTR(1:LEN_TRIM(TEMPSTR)-1)
READ(TEMPSTR,*) RASTER%NCOLS

CLOSE(LUINPUT,IOSTAT=IOS)

RASTER%XLLCORNER = RASTER%ULXMAP - 0.5 * RASTER%CELLSIZE
RASTER%YLLCORNER = RASTER%ULYMAP + 0.5 * RASTER%CELLSIZE - REAL(RASTER%NROWS) * RASTER%CELLSIZE 

RASTER%NCOLS         = RASTER%NCOLS * 3
RASTER%NROWS         = RASTER%NROWS * 3
RASTER%BANDROWBYTES  = (RASTER%NBITS/8) * RASTER%NCOLS
RASTER%TOTALROWBYTES = RASTER%BANDROWBYTES * RASTER%NBANDS

100 FORMAT(A)

! *****************************************************************************
END SUBROUTINE READ_BSQ_HEADER_EXISTING_TILED
! *****************************************************************************

! *****************************************************************************
SUBROUTINE READ_BSQ_RASTER(RASTER,INDIR,FN)
! *****************************************************************************

#ifdef __INTEL_COMPILER
USE IFPORT
#endif

TYPE (RASTER_TYPE) :: RASTER
CHARACTER(400), INTENT (IN) :: INDIR,FN
CHARACTER(400) :: FNHDR, FNBSQ, FNTIF, FNPRJ, FNXML, SHELLSTR, TEMPSTR
INTEGER :: I, J, IOS, IBAND, ISTAT, ITYPE, IDUMMY, IROW1, IROW2
INTEGER*8 :: LRECL
LOGICAL :: FOUND
REAL, ALLOCATABLE, DIMENSION(:) :: RVALUES
REAL, ALLOCATABLE, DIMENSION(:,:) :: RTEMP
INTEGER*2, ALLOCATABLE, DIMENSION(:) :: I2VALUES
INTEGER*2, ALLOCATABLE, DIMENSION(:,:) :: I2TEMP

IF (VRT_INSTEAD_OF_TIF) THEN
   FNTIF = TRIM(INDIR) // TRIM(FN) // '.vrt'
ELSE
   FNTIF = TRIM(INDIR) // TRIM(FN) // '.tif'
ENDIF

IF (TRIM(SCRATCH) .EQ. 'null') THEN
   FNHDR = TRIM(INDIR) // TRIM(FN) // '.hdr'
   FNBSQ = TRIM(INDIR) // TRIM(FN) // '.bsq'
   FNPRJ = TRIM(INDIR) // TRIM(FN) // '.prj'
   FNXML = TRIM(FNBSQ) // '.aux.xml'
ELSE
   FNHDR = TRIM(SCRATCH) // TRIM(FN) // '.hdr'
   FNBSQ = TRIM(SCRATCH) // TRIM(FN) // '.bsq'
   FNPRJ = TRIM(SCRATCH) // TRIM(FN) // '.prj'
   FNXML = TRIM(FNBSQ) // '.aux.xml'
ENDIF

! Convert to ENVI header BSQ format
IF (.NOT. USE_EXISTING_BSQS) THEN
   SHELLSTR = TRIM(DELETECOMMAND) // " " // TRIM(FNBSQ) // " " // TRIM(FNHDR) // " " // TRIM(FNPRJ) // " " // TRIM(FNXML)
   WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR))
   SHELLSTR = TRIM(PATH_TO_GDAL) // 'gdal_translate -of ENVI -co "INTERLEAVE=BSQ" ' // TRIM(FNTIF) // " " // TRIM(FNBSQ)
   WRITE(*,100) TRIM(SHELLSTR); CALL EXECUTE_COMMAND_LINE(TRIM(SHELLSTR))
ENDIF

! Open and parse BSQ XML:
OPEN(LUINPUT,FILE=TRIM(FNXML),FORM='FORMATTED',STATUS='OLD',IOSTAT=IOS) 
IF (IOS .GT. 0) THEN
   WRITE(*,*) 'Problem opening bsq xml header ', TRIM(FNXML)
   WRITE(*,*) 'IOS: ', IOS
   STOP
ENDIF

! Trash first five lines
DO I = 1, 5
   READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
   CONTINUE
ENDDO

! Read number of bands:
READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
READ(TEMPSTR(22:30),*) TEMPSTR
TEMPSTR=TEMPSTR(1:LEN_TRIM(TEMPSTR)-1)
READ(TEMPSTR,*,IOSTAT=IOS) RASTER%NBANDS

IF (IOS .NE. 0) THEN
   RASTER%NBANDS=1
ENDIF

! Skip over byte order:
READ(LUINPUT,100,IOSTAT=IOS)

! Read data type
READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
READ(TEMPSTR(26:26),*) TEMPSTR
READ(TEMPSTR,*) ITYPE
IF (ITYPE .EQ. 2) THEN
   RASTER%PIXELTYPE='SIGNEDINT'
   RASTER%NBITS=16
ENDIF
IF (ITYPE .EQ. 4) THEN
   RASTER%PIXELTYPE='FLOAT'
   RASTER%NBITS=32
ENDIF

! Skip 3 more lines
DO I = 1, 3
   READ(LUINPUT,100,IOSTAT=IOS)
ENDDO

! Read number of rows:
READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
READ(TEMPSTR(22:30),*) TEMPSTR
TEMPSTR=TEMPSTR(1:LEN_TRIM(TEMPSTR)-1)
READ(TEMPSTR,*) RASTER%NROWS

! Read number of columns:
READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
READ(TEMPSTR(24:32),*) TEMPSTR
TEMPSTR=TEMPSTR(1:LEN_TRIM(TEMPSTR)-1)
READ(TEMPSTR,*) RASTER%NCOLS

! Set BANDROWBYTES and TOTALROWBYTES:
RASTER%BANDROWBYTES  = (RASTER%NBITS/8) * RASTER%NCOLS
RASTER%TOTALROWBYTES = RASTER%BANDROWBYTES * RASTER%NBANDS

! Skip 5 or 6 more lines
DO I = 1, 5
   READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
ENDDO

IF (LEN_TRIM(TEMPSTR) .LT. 15) THEN !This checks to see if we need to trash one more line
   READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
ENDIF

! Read nodata:
READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
READ(TEMPSTR(18:41),*) TEMPSTR
TEMPSTR=TEMPSTR(1:LEN_TRIM(TEMPSTR)-1)
READ(TEMPSTR,*) RASTER%NODATA_VALUE

! Close .xml file:
CLOSE(LUINPUT)

! Open and parse BSQ header:
OPEN(LUINPUT,FILE=TRIM(FNHDR),FORM='FORMATTED',STATUS='OLD',IOSTAT=IOS) 
IF (IOS .GT. 0) THEN
   WRITE(*,*) 'Problem opening bsq header ', TRIM(FNHDR)
ENDIF

IF (DEBUG_LEVEL .GT. 100) WRITE(*,*) 'Reading bsq header'

! Skip 11 lines
DO I = 1, 11
   READ(LUINPUT,100,IOSTAT=IOS)
ENDDO

! Read easting, northing, and cell size info:
READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
FOUND=.FALSE.; I=1
DO WHILE (.NOT. FOUND)
   IF(TEMPSTR(I:I) .EQ. ',') THEN
      FOUND=.TRUE.
   ELSE
      I=I+1
   ENDIF
ENDDO
J=I+1
DO I=1,100
   IF (TEMPSTR(I:I) .EQ. '}') TEMPSTR(I:I)=' '
ENDDO
READ(TEMPSTR(J:),*) IDUMMY, IDUMMY, RASTER%XLLCORNER, RASTER%YLLCORNER, RASTER%XDIM, RASTER%YDIM
RASTER%YLLCORNER = RASTER%YLLCORNER - RASTER%YDIM * RASTER%NROWS
CLOSE(LUINPUT)

! Check to make sure x and y cell sizes are the same:
IF (RASTER%XDIM .NE. RASTER%YDIM) THEN
   WRITE(*,*) 'Error opening ', TRIM(FNHDR), ' because XDIM is not equal to YDIM.'
   STOP
ELSE
   RASTER%CELLSIZE=RASTER%XDIM
ENDIF

! Set ULXMAP and ULYMAP
RASTER%ULXMAP = RASTER%XLLCORNER + 0.5 * RASTER%CELLSIZE
RASTER%ULYMAP = RASTER%YLLCORNER + RASTER%NROWS * RASTER%CELLSIZE - 0.5 * RASTER%CELLSIZE

! Set BYTEORDER and LAYOUT
RASTER%BYTEORDER = '0'
RASTER%LAYOUT    = 'BSQ'

! This is for bil:
RASTER%BYTEORDER = 'I'
RASTER%LAYOUT    = 'BIL'

SELECT CASE(TRIM(RASTER%PIXELTYPE))

   CASE('FLOAT')
!     Allocate arrays as appropriate:
      IF (.NOT. ASSOCIATED(RASTER%R4)) ALLOCATE(RASTER%R4(1:RASTER%NCOLS,1:RASTER%NROWS,1:RASTER%NBANDS))
      ALLOCATE(RVALUES(1:RASTER%NROWS*RASTER%NCOLS))
      ALLOCATE(RTEMP(1:RASTER%NCOLS,1:RASTER%NROWS))

!Open raster bsq file:
      INQUIRE (IOLENGTH=LRECL) RVALUES(:) 

      OPEN(LUINPUT, FILE=TRIM(FNBSQ), ACCESS='DIRECT', STATUS='OLD', RECL=LRECL, IOSTAT=IOS) 
      IF (IOS .GT. 0) THEN
         WRITE(*,*) 'Problem opening raster file ', TRIM(FNBSQ)
         STOP
      ENDIF

      DO IBAND = 1, RASTER%NBANDS
         READ(LUINPUT,REC=IBAND,IOSTAT=IOS) RVALUES(:)
         RTEMP(:,:) = RESHAPE(RVALUES, (/RASTER%NCOLS,RASTER%NROWS/))
         DO IROW1 = 1, RASTER%NROWS
            IROW2 = RASTER%NROWS + 1 - IROW1 
            RASTER%R4(:,IROW1,IBAND) = RTEMP(:,IROW2)
         ENDDO
      ENDDO

      DEALLOCATE(RVALUES, RTEMP)

   CASE('SIGNEDINT')
!     Allocate arrays as appropriate:
      IF (.NOT. ASSOCIATED(RASTER%I2)) ALLOCATE(RASTER%I2(1:RASTER%NCOLS,1:RASTER%NROWS,1:RASTER%NBANDS) )
      ALLOCATE(I2VALUES(1:RASTER%NROWS*RASTER%NCOLS))
      ALLOCATE(I2TEMP(1:RASTER%NCOLS,1:RASTER%NROWS))

!Open raster bsq file:
      INQUIRE (IOLENGTH=LRECL) I2VALUES(:) 

      OPEN(LUINPUT, FILE=TRIM(FNBSQ), ACCESS='DIRECT', STATUS='OLD', RECL=LRECL, IOSTAT=IOS) 
      IF (IOS .GT. 0) THEN
         WRITE(*,*) 'Problem opening raster file ', TRIM(FNBSQ)
         STOP
      ENDIF

      DO IBAND = 1, RASTER%NBANDS
         READ(LUINPUT,REC=IBAND,IOSTAT=IOS) I2VALUES(:)
         I2TEMP(:,:) = RESHAPE(I2VALUES, (/RASTER%NCOLS,RASTER%NROWS/))

         DO IROW1 = 1, RASTER%NROWS
            IROW2 = RASTER%NROWS + 1 - IROW1 
            RASTER%I2(:,IROW1,IBAND) = I2TEMP(:,IROW2)
         ENDDO

      ENDDO

      DEALLOCATE(I2VALUES, I2TEMP)

   CASE DEFAULT
      CONTINUE

END SELECT

CLOSE(LUINPUT,IOSTAT=IOS)

100 FORMAT(A)

! *****************************************************************************
END SUBROUTINE READ_BSQ_RASTER
! *****************************************************************************

! *****************************************************************************
SUBROUTINE READ_BSQ_RASTER_EXISTING_TILED(RASTER,FNIN)
! *****************************************************************************

#ifdef __INTEL_COMPILER
USE IFPORT
#endif

TYPE (RASTER_TYPE), INTENT(INOUT) :: RASTER
CHARACTER(400), INTENT (IN) :: FNIN
CHARACTER(400) :: FNHDR, FNBSQ, FNXML, TEMPSTR
INTEGER :: I, J, IOS, IBAND, ITYPE, ITILE, JTILE
INTEGER :: IROW_BIG, IROW_SMALL, ICOL_BIG_LO, ICOL_BIG_HI, IROW_BIG_LO, IROW_BIG_HI, IDUMMY
INTEGER*8 :: LRECL
LOGICAL :: FOUND
REAL, ALLOCATABLE, DIMENSION(:) :: RVALUES
REAL, ALLOCATABLE, DIMENSION(:,:) :: RTEMP

INTEGER*2, ALLOCATABLE, DIMENSION(:) :: I2VALUES
INTEGER*2, ALLOCATABLE, DIMENSION(:,:) :: I2TEMP

CHARACTER(1), DIMENSION(1:3), PARAMETER :: CINDEX = (/'1', '2', '3'/)

DO ITILE = 1, 3
DO JTILE = 1, 3

   FNHDR = TRIM(FNIN) // '_' // CINDEX(ITILE) // '_' // CINDEX(JTILE) // '.hdr'
   FNBSQ = TRIM(FNIN) // '_' // CINDEX(ITILE) // '_' // CINDEX(JTILE) // '.bsq'
   FNXML = TRIM(FNBSQ) // '.aux.xml'

!Open and parse bsq header:
   IF (ITILE .EQ. 1. .AND. JTILE .EQ. 1) THEN

      OPEN(LUINPUT,FILE=TRIM(FNXML),FORM='FORMATTED',STATUS='OLD',IOSTAT=IOS) 
      IF (IOS .GT. 0) THEN
         WRITE(*,*) 'Problem opening bsq xml header ', TRIM(FNXML)
         WRITE(*,*) 'IOS: ', IOS
         STOP
      ENDIF

! Trash first five lines
      DO I = 1, 5
         READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
         CONTINUE
      ENDDO

! Read number of bands:
      READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
      READ(TEMPSTR(22:30),*) TEMPSTR
      TEMPSTR=TEMPSTR(1:LEN_TRIM(TEMPSTR)-1)
      READ(TEMPSTR,*,IOSTAT=IOS) RASTER%NBANDS

      IF (IOS .NE. 0) THEN
         RASTER%NBANDS=1
      ENDIF

! Skip over byte order:
      READ(LUINPUT,100,IOSTAT=IOS)

! Read data type
      READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
      READ(TEMPSTR(26:26),*) TEMPSTR
      READ(TEMPSTR,*) ITYPE
      IF (ITYPE .EQ. 2) THEN
         RASTER%PIXELTYPE='SIGNEDINT'
         RASTER%NBITS=16
      ENDIF
      IF (ITYPE .EQ. 4) THEN
         RASTER%PIXELTYPE='FLOAT'
         RASTER%NBITS=32
      ENDIF

! Skip 3 more lines
      DO I = 1, 3
         READ(LUINPUT,100,IOSTAT=IOS)
      ENDDO

! Read number of rows:
      READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
      READ(TEMPSTR(22:30),*) TEMPSTR
      TEMPSTR=TEMPSTR(1:LEN_TRIM(TEMPSTR)-1)
      READ(TEMPSTR,*) RASTER%NROWS

! Read number of columns:
      READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
      READ(TEMPSTR(24:32),*) TEMPSTR
      TEMPSTR=TEMPSTR(1:LEN_TRIM(TEMPSTR)-1)
      READ(TEMPSTR,*) RASTER%NCOLS

! Set BANDROWBYTES and TOTALROWBYTES:
      RASTER%BANDROWBYTES  = (RASTER%NBITS/8) * RASTER%NCOLS
      RASTER%TOTALROWBYTES = RASTER%BANDROWBYTES * RASTER%NBANDS

! Skip 5 or 6 more lines
      DO I = 1, 5
         READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
      ENDDO

      IF (LEN_TRIM(TEMPSTR) .LT. 15) THEN !This checks to see if we need to trash one more line
         READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
      ENDIF

! Read nodata:
      READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
      READ(TEMPSTR(18:41),*) TEMPSTR
      TEMPSTR=TEMPSTR(1:LEN_TRIM(TEMPSTR)-1)
      READ(TEMPSTR,*) RASTER%NODATA_VALUE

! Close .xml file:
      CLOSE(LUINPUT,IOSTAT=IOS)

! Open and parse BSQ header:
      OPEN(LUINPUT,FILE=TRIM(FNHDR),FORM='FORMATTED',STATUS='OLD',IOSTAT=IOS) 
      IF (IOS .GT. 0) THEN
         WRITE(*,*) 'Problem opening bsq header ', TRIM(FNHDR)
      ENDIF

      IF (DEBUG_LEVEL .GT. 100) WRITE(*,*) 'Reading bsq header'

! Skip 11 lines
      DO I = 1, 11
         READ(LUINPUT,100,IOSTAT=IOS)
      ENDDO

! Read easting, northing, and cell size info:
      READ(LUINPUT,100,IOSTAT=IOS) TEMPSTR
      FOUND=.FALSE.; I=1
      DO WHILE (.NOT. FOUND)
         IF(TEMPSTR(I:I) .EQ. ',') THEN
            FOUND=.TRUE.
         ELSE
            I=I+1
         ENDIF
      ENDDO
      J=I+1
      DO I=1,100
         IF (TEMPSTR(I:I) .EQ. '}') TEMPSTR(I:I)=' '
      ENDDO
      READ(TEMPSTR(J:),*) IDUMMY, IDUMMY, RASTER%XLLCORNER, RASTER%YLLCORNER, RASTER%XDIM, RASTER%YDIM
      RASTER%YLLCORNER = RASTER%YLLCORNER - RASTER%YDIM * RASTER%NROWS
      CLOSE(LUINPUT)

! Check to make sure x and y cell sizes are the same:
      IF (RASTER%XDIM .NE. RASTER%YDIM) THEN
         WRITE(*,*) 'Error opening ', TRIM(FNHDR), ' because XDIM is not equal to YDIM.'
         STOP
      ELSE
         RASTER%CELLSIZE=RASTER%XDIM
      ENDIF

! Set ULXMAP and ULYMAP
      RASTER%ULXMAP = RASTER%XLLCORNER + 0.5 * RASTER%CELLSIZE
      RASTER%ULYMAP = RASTER%YLLCORNER + RASTER%NROWS * RASTER%CELLSIZE - 0.5 * RASTER%CELLSIZE

! This is for bil (because file is dumped as bil):
      RASTER%BYTEORDER = 'I'
      RASTER%LAYOUT    = 'BIL'

      SELECT CASE(TRIM(RASTER%PIXELTYPE))

         CASE('FLOAT')
            IF (.NOT. ASSOCIATED(RASTER%R4)) THEN
               ALLOCATE(RASTER%R4(1:3*RASTER%NCOLS,1:3*RASTER%NROWS,1:RASTER%NBANDS) )
               RASTER%R4(:,:,:) = RASTER%NODATA_VALUE
            ENDIF

            ALLOCATE(RVALUES(1:RASTER%NROWS*RASTER%NCOLS  ))
            ALLOCATE(RTEMP  (1:RASTER%NCOLS,1:RASTER%NROWS))

         CASE('SIGNEDINT')
            IF (.NOT. ASSOCIATED(RASTER%I2)) THEN
               ALLOCATE(RASTER%I2(1:3*RASTER%NCOLS,1:3*RASTER%NROWS,1:RASTER%NBANDS) )
               RASTER%I2(:,:,:) = NINT(RASTER%NODATA_VALUE,2)
            ENDIF

            ALLOCATE(I2VALUES(1:RASTER%NROWS*RASTER%NCOLS  ))
            ALLOCATE(I2TEMP  (1:RASTER%NCOLS,1:RASTER%NROWS))

      END SELECT

   ENDIF ! ITILE .EQ. 1. .AND. JTILE .EQ. 1

   ICOL_BIG_LO = (ITILE - 1) * RASTER%NCOLS + 1
   ICOL_BIG_HI = ICOL_BIG_LO + RASTER%NCOLS - 1

   IROW_BIG_LO = (JTILE - 1) * RASTER%NROWS + 1
   IROW_BIG_HI = IROW_BIG_LO + RASTER%NROWS - 1

   SELECT CASE(TRIM(RASTER%PIXELTYPE))

      CASE('FLOAT')

         INQUIRE (IOLENGTH=LRECL) RVALUES(:)

         OPEN(LUINPUT, FILE=TRIM(FNBSQ), ACCESS='DIRECT', STATUS='OLD', RECL=LRECL, IOSTAT=IOS) 
         IF (IOS .GT. 0) THEN
            WRITE(*,*) 'Problem opening raster file ', TRIM(FNBSQ)
            STOP
         ENDIF

         DO IBAND = 1, RASTER%NBANDS
            READ(LUINPUT,REC=IBAND,IOSTAT=IOS) RVALUES(:)
            RTEMP(:,:) = RESHAPE(RVALUES, (/RASTER%NCOLS,RASTER%NROWS/))

            IROW_SMALL = RASTER%NROWS
            DO IROW_BIG = IROW_BIG_LO, IROW_BIG_HI
               RASTER%R4(ICOL_BIG_LO:ICOL_BIG_HI,IROW_BIG,IBAND) = RTEMP(:,IROW_SMALL)
               IROW_SMALL = IROW_SMALL - 1
            ENDDO
         ENDDO

      CASE('SIGNEDINT')

         INQUIRE (IOLENGTH=LRECL) I2VALUES(:) 

         OPEN(LUINPUT, FILE=TRIM(FNBSQ), ACCESS='DIRECT', STATUS='OLD', RECL=LRECL, IOSTAT=IOS) 
         IF (IOS .GT. 0) THEN
            WRITE(*,*) 'Problem opening raster file ', TRIM(FNBSQ)
            STOP
         ENDIF

         DO IBAND = 1, RASTER%NBANDS
            READ(LUINPUT,REC=IBAND,IOSTAT=IOS) I2VALUES(:)
            I2TEMP(:,:) = RESHAPE(I2VALUES, (/RASTER%NCOLS,RASTER%NROWS/))

            IROW_SMALL = RASTER%NROWS
            DO IROW_BIG = IROW_BIG_LO, IROW_BIG_HI
               RASTER%I2(ICOL_BIG_LO:ICOL_BIG_HI,IROW_BIG,IBAND) = I2TEMP(:,IROW_SMALL)
               IROW_SMALL = IROW_SMALL - 1
            ENDDO
         ENDDO

   END SELECT

   CLOSE(LUINPUT,IOSTAT=IOS)

ENDDO
ENDDO

RASTER%ULYMAP = RASTER%ULYMAP + 2 * REAL(RASTER%NROWS) * RASTER%CELLSIZE 

RASTER%NCOLS         = RASTER%NCOLS * 3
RASTER%NROWS         = RASTER%NROWS * 3
RASTER%BANDROWBYTES  = (RASTER%NBITS/8) * RASTER%NCOLS
RASTER%TOTALROWBYTES = RASTER%BANDROWBYTES * RASTER%NBANDS

CONTINUE

SELECT CASE(TRIM(RASTER%PIXELTYPE))
   CASE('FLOAT')
      DEALLOCATE(RVALUES)
      DEALLOCATE(RTEMP)
   CASE('SIGNEDINT')
      DEALLOCATE(I2VALUES)
      DEALLOCATE(I2TEMP)
END SELECT

100 FORMAT(A)

! *****************************************************************************
END SUBROUTINE READ_BSQ_RASTER_EXISTING_TILED
! *****************************************************************************

! *****************************************************************************
SUBROUTINE NEW_DUMP_ROUTINE(L,PREFIX,TIMENOW,QUANTITY,ICASE)
! *****************************************************************************

#ifdef __INTEL_COMPILER
USE IFPORT
#endif

TYPE (DLL), INTENT(INOUT) :: L
CHARACTER(*), INTENT(IN) :: PREFIX,QUANTITY
REAL, INTENT(IN) :: TIMENOW
INTEGER, INTENT(IN) :: ICASE

INTEGER :: I,IT
REAL :: ULXMAP,ULYMAP

CHARACTER(7) :: SEVEN
CHARACTER(7) :: CTSEC
CHARACTER(400) :: FN

TYPE(RASTER_TYPE), SAVE :: RDUMPME
TYPE(RASTER_TYPE), POINTER :: R
TYPE(NODE), POINTER :: C

C => L%HEAD
DO I = 1, L%NUM_NODES
   SELECT CASE (TRIM(QUANTITY))
      CASE ('time_suppressed')
          C%DUMPME = C%TIME_SUPPRESSED
      CASE ('time_added')
          C%DUMPME = C%TIME_ADDED
      CASE ('time_of_arrival')
          C%DUMPME = C%TIME_OF_ARRIVAL
      CASE DEFAULT
         WRITE(*,*) 'Quantity ', TRIM(QUANTITY), 'not found'
   END SELECT
   C => C%NEXT
ENDDO

IF (.NOT. ASSOCIATED(RDUMPME%R4)) THEN
   R=>ASP
   CALL ALLOCATE_EMPTY_RASTER(RDUMPME,  R%NCOLS, R%NROWS, 1, R%XLLCORNER, R%YLLCORNER, R%CELLSIZE, R%NODATA_VALUE, 'FLOAT     ')
ENDIF
   
WRITE(SEVEN, '(I7.7)') ICASE

IT=NINT(TIMENOW)
WRITE(CTSEC,'(I7)') IT
IF (IT .GE.       0 .AND. IT .LT.       10) CTSEC = '000000' // ADJUSTL(CTSEC) 
IF (IT .GE.      10 .AND. IT .LT.      100) CTSEC = '00000'  // ADJUSTL(CTSEC) 
IF (IT .GE.     100 .AND. IT .LT.     1000) CTSEC = '0000'   // ADJUSTL(CTSEC) 
IF (IT .GE.    1000 .AND. IT .LT.    10000) CTSEC = '000'    // ADJUSTL(CTSEC) 
IF (IT .GE.   10000 .AND. IT .LT.   100000) CTSEC = '00'     // ADJUSTL(CTSEC) 
IF (IT .GE.  100000 .AND. IT .LT.  1000000) CTSEC = '0'      // ADJUSTL(CTSEC) 

ULXMAP = ANALYSIS_XLLCORNER + 0.5 * ANALYSIS_CELLSIZE
ULYMAP = ANALYSIS_YLLCORNER + REAL(ANALYSIS_NROWS) * ANALYSIS_CELLSIZE - 0.5*ANALYSIS_CELLSIZE
RDUMPME%ULXMAP=ULXMAP; RDUMPME%ULYMAP=ULYMAP

RDUMPME%R4(:,:,:) = RDUMPME%NODATA_VALUE
C => L%HEAD
DO I = 1, L%NUM_NODES
   RDUMPME%R4(C%IX,C%IY,1) = C%DUMPME
   C => C%NEXT
ENDDO
FN = TRIM(PREFIX) // '_' // SEVEN // '_' // CTSEC
CALL WRITE_BIL_RASTER(RDUMPME,OUTPUTS_DIRECTORY,FN,.FALSE.,.FALSE.)

! *****************************************************************************
END SUBROUTINE NEW_DUMP_ROUTINE
! *****************************************************************************

! *****************************************************************************
SUBROUTINE MAIN_DUMP_ROUTINE(IDUMPCOUNT, NDUMPS, ICASE, T, DUMPEDYET, ACRES)
! *****************************************************************************

#ifdef __INTEL_COMPILER
USE IFPORT
#endif

INTEGER, INTENT(INOUT) :: IDUMPCOUNT
INTEGER, INTENT(IN) :: NDUMPS, ICASE
REAL, INTENT(IN) :: T, ACRES
LOGICAL, INTENT(INOUT) :: DUMPEDYET
INTEGER :: IT, IOS
LOGICAL :: LOPEN

CHARACTER(7) :: SEVEN
CHARACTER(7) :: CTSEC
CHARACTER(400) :: FN,DIR,OGR2OGR,GDAL_CONTOUR
CHARACTER(100), DIMENSION(0:200), SAVE :: FNS_SURFACE_FIRE, FNS_CROWN_FIRE, FNS_SPREAD_RATE, FNS_HPUA, FNS_FLIN, FNS_FLAME_LENGTH, &
                                          FNS_REACTION_INTENSITY, FNS_WS20, FNS_WD20, FNS_VELOCITY, FNS_SPOTTING_IGN_TIME, &
                                          FNS_TIME_OF_ARRIVAL, FNS_TAGGED, FNS_PHI, FNS_EMBER_FLUX

CHARACTER(20000) :: SHELLSTR, FN_SURFACE_FIRE_BIL, FN_CROWN_FIRE_BIL, FN_SPREAD_RATE_BIL, FN_HPUA_BIL, FN_FLIN_BIL, &
                   FN_FLAME_LENGTH_BIL, FN_REACTION_INTENSITY_BIL, FN_WS20_BIL, FN_WD20_BIL, FN_VELOCITY_BIL, &
                   FN_SPOTTING_IGN_TIME_BIL, FN_TIME_OF_ARRIVAL_BIL, FN_TAGGED_BIL, FN_PHI_BIL, FN_EMBER_FLUX_BIL, &
                   FN_SURFACE_FIRE_HDR, FN_CROWN_FIRE_HDR, FN_SPREAD_RATE_HDR, FN_HPUA_HDR, FN_FLIN_HDR, &
                   FN_FLAME_LENGTH_HDR, FN_REACTION_INTENSITY_HDR, FN_WS20_HDR, FN_WD20_HDR, FN_VELOCITY_HDR, &
                   FN_SPOTTING_IGN_TIME_HDR, FN_TIME_OF_ARRIVAL_HDR, FN_TAGGED_HDR, FN_PHI_HDR, FN_EMBER_FLUX_HDR, &
                   FN_SURFACE_FIRE_TIF,FN_CROWN_FIRE_TIF,FN_SPREAD_RATE_TIF, FN_HPUA_TIF, FN_FLIN_TIF, &
                   FN_FLAME_LENGTH_TIF, FN_REACTION_INTENSITY_TIF, FN_WS20_TIF, FN_WD20_TIF, FN_VELOCITY_TIF, &
                   FN_SPOTTING_IGN_TIME_TIF, FN_TIME_OF_ARRIVAL_TIF, FN_TAGGED_TIF, FN_PHI_TIF, FN_EMBER_FLUX_TIF


INTEGER :: I, ISTAT
REAL :: ULXMAP,ULYMAP

TYPE(RASTER_TYPE), SAVE :: I2DUMPME, RDUMPME
TYPE(RASTER_TYPE), POINTER :: R
TYPE(NODE), POINTER :: C

IF (.NOT. ASSOCIATED(I2DUMPME%I2)) THEN
   R=>ASP
   CALL ALLOCATE_EMPTY_RASTER(I2DUMPME, R%NCOLS, R%NROWS, 1, R%XLLCORNER, R%YLLCORNER, R%CELLSIZE, R%NODATA_VALUE, 'SIGNEDINT ')
   CALL ALLOCATE_EMPTY_RASTER(RDUMPME,  R%NCOLS, R%NROWS, 1, R%XLLCORNER, R%YLLCORNER, R%CELLSIZE, R%NODATA_VALUE, 'FLOAT     ')
ENDIF

IF (IDUMPCOUNT .GT. NDUMPS) RETURN
   
WRITE(SEVEN, '(I7.7)') ICASE

IT=NINT(T)
WRITE(CTSEC,'(I7)') IT
IF (IT .GE.       0 .AND. IT .LT.       10) CTSEC = '000000' // ADJUSTL(CTSEC) 
IF (IT .GE.      10 .AND. IT .LT.      100) CTSEC = '00000'  // ADJUSTL(CTSEC) 
IF (IT .GE.     100 .AND. IT .LT.     1000) CTSEC = '0000'   // ADJUSTL(CTSEC) 
IF (IT .GE.    1000 .AND. IT .LT.    10000) CTSEC = '000'    // ADJUSTL(CTSEC) 
IF (IT .GE.   10000 .AND. IT .LT.   100000) CTSEC = '00'     // ADJUSTL(CTSEC) 
IF (IT .GE.  100000 .AND. IT .LT.  1000000) CTSEC = '0'      // ADJUSTL(CTSEC) 

! Write acres
IF (DUMP_TRANSIENT_ACREAGE) THEN
   FN = TRIM(OUTPUTS_DIRECTORY) // 'acres_' // SEVEN // '.csv'
   INQUIRE(FILE=TRIM(FN), OPENED=LOPEN)
   IF (.NOT. LOPEN) THEN
      OPEN(LUOUTPUT-3,FILE=TRIM(FN),FORM='FORMATTED',STATUS='REPLACE',IOSTAT=IOS)
      WRITE(LUOUTPUT-3,100) 'time(s),acres'
   ENDIF
   WRITE(LUOUTPUT-3,200) T, ACRES
ENDIF
200 FORMAT (F9.1, ',', F9.1)

ULXMAP = ANALYSIS_XLLCORNER + 0.5 * ANALYSIS_CELLSIZE
ULYMAP = ANALYSIS_YLLCORNER + REAL(ANALYSIS_NROWS) * ANALYSIS_CELLSIZE - 0.5*ANALYSIS_CELLSIZE
I2DUMPME%ULXMAP=ULXMAP; I2DUMPME%ULYMAP=ULYMAP
RDUMPME%ULXMAP=ULXMAP; RDUMPME%ULYMAP=ULYMAP

IF (DUMP_SURFACE_FIRE) THEN
   I2DUMPME%I2(:,:,1) = SURFACE_FIRE(:,:)
   FN = 'surface_fire_' // SEVEN // '_' // CTSEC
   CALL WRITE_BIL_RASTER(I2DUMPME,OUTPUTS_DIRECTORY,FN,CONVERT_TO_GEOTIFF,.TRUE.)
   FNS_SURFACE_FIRE(IDUMPCOUNT) = TRIM(FN)
ENDIF
      
IF (DUMP_CROWN_FIRE) THEN
   I2DUMPME%I2(:,:,:) = NINT(I2DUMPME%NODATA_VALUE,2)
   C => LIST_BURNED%HEAD
   DO I = 1, LIST_BURNED%NUM_NODES
      I2DUMPME%I2(C%IX,C%IY,1) = C%CROWN_FIRE
      C => C%NEXT
   ENDDO
   FN = 'crown_fire_' // SEVEN // '_' // CTSEC
   CALL WRITE_BIL_RASTER(I2DUMPME,OUTPUTS_DIRECTORY,FN,CONVERT_TO_GEOTIFF,.TRUE.)
   FNS_CROWN_FIRE(IDUMPCOUNT) = TRIM(FN)
ENDIF

IF (DUMP_SPREAD_RATE .AND. IDUMPCOUNT .EQ. NDUMPS) THEN
   RDUMPME%R4(:,:,:) = RDUMPME%NODATA_VALUE
   C => LIST_BURNED%HEAD
   DO I = 1, LIST_BURNED%NUM_NODES
      RDUMPME%R4(C%IX,C%IY,1) = C%VELOCITY
      C => C%NEXT
   ENDDO
   FN = 'vs_' // SEVEN // '_' // CTSEC
   CALL WRITE_BIL_RASTER(RDUMPME,OUTPUTS_DIRECTORY,FN,CONVERT_TO_GEOTIFF,.TRUE.)
   FNS_SPREAD_RATE(IDUMPCOUNT) = TRIM(FN)
ENDIF

IF (DUMP_HPUA  .AND. IDUMPCOUNT .EQ. NDUMPS) THEN
   RDUMPME%R4(:,:,:) = RDUMPME%NODATA_VALUE
   C => LIST_BURNED%HEAD
   DO I = 1, LIST_BURNED%NUM_NODES
      RDUMPME%R4(C%IX,C%IY,1) = C%HPUA_SURFACE + C%HPUA_CANOPY
      C => C%NEXT
   ENDDO
   FN = 'hpua_' // SEVEN // '_' // CTSEC
   CALL WRITE_BIL_RASTER(RDUMPME,OUTPUTS_DIRECTORY,FN,CONVERT_TO_GEOTIFF,.TRUE.)
   FNS_HPUA(IDUMPCOUNT) = TRIM(FN)
ENDIF

IF (DUMP_FLIN  .AND. IDUMPCOUNT .EQ. NDUMPS) THEN
   RDUMPME%R4(:,:,:) = RDUMPME%NODATA_VALUE
   C => LIST_BURNED%HEAD
   DO I = 1, LIST_BURNED%NUM_NODES
      RDUMPME%R4(C%IX,C%IY,1) = C%FLIN_SURFACE + C%FLIN_CANOPY
      C => C%NEXT
   ENDDO
   FN = 'flin_' // SEVEN // '_' // CTSEC
   CALL WRITE_BIL_RASTER(RDUMPME,OUTPUTS_DIRECTORY,FN,CONVERT_TO_GEOTIFF,.TRUE.)
   FNS_FLIN(IDUMPCOUNT) = TRIM(FN)
ENDIF

IF (DUMP_FLAME_LENGTH  .AND. IDUMPCOUNT .EQ. NDUMPS) THEN
   RDUMPME%R4(:,:,:) = RDUMPME%NODATA_VALUE
   C => LIST_BURNED%HEAD
   DO I = 1, LIST_BURNED%NUM_NODES
      RDUMPME%R4(C%IX,C%IY,1) = C%FLAME_LENGTH
      C => C%NEXT
   ENDDO
   FN = 'flame_length_' // SEVEN // '_' // CTSEC
   CALL WRITE_BIL_RASTER(RDUMPME,OUTPUTS_DIRECTORY,FN,CONVERT_TO_GEOTIFF,.TRUE.)
   FNS_FLAME_LENGTH(IDUMPCOUNT) = TRIM(FN)
ENDIF

IF (DUMP_REACTION_INTENSITY  .AND. IDUMPCOUNT .EQ. NDUMPS) THEN
   RDUMPME%R4(:,:,:) = RDUMPME%NODATA_VALUE
   C => LIST_BURNED%HEAD
   DO I = 1, LIST_BURNED%NUM_NODES
      RDUMPME%R4(C%IX,C%IY,1) = C%IR
      C => C%NEXT
   ENDDO
   FN = 'ir_' // SEVEN // '_' // CTSEC
   CALL WRITE_BIL_RASTER(RDUMPME,OUTPUTS_DIRECTORY,FN,CONVERT_TO_GEOTIFF,.TRUE.)
   FNS_REACTION_INTENSITY(IDUMPCOUNT) = TRIM(FN)
ENDIF

IF (DUMP_WS20) THEN
   RDUMPME%R4(:,:,:) = RDUMPME%NODATA_VALUE
   C => LIST_TAGGED%HEAD
   DO I = 1, LIST_TAGGED%NUM_NODES
      RDUMPME%R4(C%IX,C%IY,1) = C%WS20_NOW
      C => C%NEXT
   ENDDO
   FN = 'ws20_' // SEVEN // '_' // CTSEC
   CALL WRITE_BIL_RASTER(RDUMPME,OUTPUTS_DIRECTORY,FN,CONVERT_TO_GEOTIFF,.TRUE.)
   FNS_WS20(IDUMPCOUNT) = TRIM(FN)
ENDIF

IF (DUMP_WD20) THEN
   RDUMPME%R4(:,:,:) = RDUMPME%NODATA_VALUE
   C => LIST_TAGGED%HEAD
   DO I = 1, LIST_TAGGED%NUM_NODES
      RDUMPME%R4(C%IX,C%IY,1) = C%WD20_NOW
      C => C%NEXT
   ENDDO
   FN = 'wd20_' // SEVEN // '_' // CTSEC
   CALL WRITE_BIL_RASTER(RDUMPME,OUTPUTS_DIRECTORY,FN,CONVERT_TO_GEOTIFF,.TRUE.)
   FNS_WD20(IDUMPCOUNT) = TRIM(FN)
ENDIF

IF (DUMP_VELOCITY .AND. IDUMPCOUNT .EQ. NDUMPS) THEN
   RDUMPME%R4(:,:,:) = RDUMPME%NODATA_VALUE
   C => LIST_BURNED%HEAD
   DO I = 1, LIST_BURNED%NUM_NODES
      RDUMPME%R4(C%IX,C%IY,1) = C%VELOCITY ! Convert to ft/min
      C => C%NEXT
   ENDDO
   FN = 'velocity_' // SEVEN // '_' // CTSEC
   CALL WRITE_BIL_RASTER(RDUMPME,OUTPUTS_DIRECTORY,FN,CONVERT_TO_GEOTIFF,.TRUE.)
   FNS_VELOCITY(IDUMPCOUNT) = TRIM(FN)
ENDIF

IF (DUMP_TIME_OF_ARRIVAL .AND. IDUMPCOUNT .EQ. NDUMPS) THEN
   RDUMPME%R4(:,:,:) = RDUMPME%NODATA_VALUE
   C => LIST_BURNED%HEAD
   DO I = 1, LIST_BURNED%NUM_NODES
      RDUMPME%R4(C%IX,C%IY,1) = C%TIME_OF_ARRIVAL
      C => C%NEXT
   ENDDO
   FN = 'time_of_arrival_' // SEVEN // '_' // CTSEC
   CALL WRITE_BIL_RASTER(RDUMPME,OUTPUTS_DIRECTORY,FN,CONVERT_TO_GEOTIFF,.TRUE.)
   FNS_TIME_OF_ARRIVAL(IDUMPCOUNT) = TRIM(FN)
ENDIF

IF (DUMP_TAGGED) THEN
   I2DUMPME%I2(:,:,:) = NINT(I2DUMPME%NODATA_VALUE,2)
   C => LIST_TAGGED%HEAD
   DO I = 1, LIST_TAGGED%NUM_NODES
      I2DUMPME%I2(C%IX,C%IY,1) = 1_2
      C => C%NEXT
   ENDDO
   FN = 'tagged_' // SEVEN // '_' // CTSEC
   CALL WRITE_BIL_RASTER(I2DUMPME,OUTPUTS_DIRECTORY,FN,CONVERT_TO_GEOTIFF,.TRUE.)
   FNS_TAGGED(IDUMPCOUNT) = TRIM(FN)
ENDIF

IF (DUMP_PHI) THEN
   RDUMPME%R4(:,:,1) = PHIP(:,:)
   FN = 'phi_' // SEVEN // '_' // CTSEC
   CALL WRITE_BIL_RASTER(RDUMPME,OUTPUTS_DIRECTORY,FN,CONVERT_TO_GEOTIFF,.TRUE.)
   FNS_PHI(IDUMPCOUNT) = TRIM(FN)
ENDIF

IF (DUMP_EMBER_FLUX .AND. IDUMPCOUNT .EQ. NDUMPS .AND. (.NOT. ACCUMULATE_EMBER_FLUX) ) THEN
   FN = 'ember_flux_' // SEVEN // '_' // CTSEC
   CALL WRITE_BIL_RASTER(EMBER_FLUX,OUTPUTS_DIRECTORY,FN,CONVERT_TO_GEOTIFF,.TRUE.)
   FNS_EMBER_FLUX(IDUMPCOUNT) = TRIM(FN)
ENDIF
  
! Now setup phi for dump:
IF (DUMP_ISOCHRONE_SHAPEFILES) THEN
   FN = 'isochrones_' // SEVEN // '_' // CTSEC

   IF (.NOT. DUMPEDYET) THEN
      SHELLSTR = TRIM(DELETECOMMAND) // " " // TRIM(SCRATCH) // "isochrones_" // SEVEN // "*.shp"; WRITE(*,100) TRIM(SHELLSTR)
      ISTAT = SYSTEM(TRIM(SHELLSTR))
      SHELLSTR = TRIM(DELETECOMMAND) // " " // TRIM(SCRATCH) // "isochrones_" // SEVEN // "*.shx"; WRITE(*,100) TRIM(SHELLSTR)
      ISTAT = SYSTEM(TRIM(SHELLSTR))
      SHELLSTR = TRIM(DELETECOMMAND) // " " // TRIM(SCRATCH) // "isochrones_" // SEVEN // "*.dbf"; WRITE(*,100) TRIM(SHELLSTR)
      ISTAT = SYSTEM(TRIM(SHELLSTR))
      SHELLSTR = TRIM(DELETECOMMAND) // " " // TRIM(OUTPUTS_DIRECTORY) // SEVEN // "*" ; WRITE(*,100) TRIM(SHELLSTR)
      ISTAT = SYSTEM(TRIM(SHELLSTR))       
   ENDIF

! Write PHI raster to scratch space:
   RDUMPME%R4(:,:,1) = PHIP(:,:)
   CALL WRITE_BIL_RASTER(RDUMPME,SCRATCH,FN,.FALSE.,.FALSE.)

   OGR2OGR=TRIM(PATH_TO_GDAL) // 'ogr2ogr' 
   GDAL_CONTOUR=TRIM(PATH_TO_GDAL) // 'gdal_contour' 

! Convert newly dumped phi raster to shapefile in scratch space. 
   SHELLSTR = TRIM(DELETECOMMAND) // " " // TRIM(SCRATCH) // 'intermediate*'
   WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR)) 

   SHELLSTR = TRIM(GDAL_CONTOUR) // " -fl 0 -a val " // TRIM(SCRATCH) // TRIM(FN) // '.bil ' // TRIM(SCRATCH) // "intermediate.shp"
   WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR)) 

   SHELLSTR = TRIM(OGR2OGR) // ' -skipfailures -nlt MULTILINESTRING -a_srs "' // TRIM(A_SRS) // '" ' // TRIM(SCRATCH) // TRIM(FN) // ".shp "  // TRIM(SCRATCH) // "intermediate.shp" 
   WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR)) 

   IF (.NOT. DUMPEDYET) THEN
      SHELLSTR = TRIM(OGR2OGR) // ' -skipfailures -nlt MULTILINESTRING -a_srs "' // TRIM(A_SRS) // '" ' // TRIM(OUTPUTS_DIRECTORY) // SEVEN // ".shp "  // TRIM(SCRATCH) // TRIM(FN) // ".shp" // &
     ' -dialect sqlite -sql "SELECT ST_Union(geometry) AS geometry FROM ' // TRIM(FN) // '"'

      WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR)) 
   ELSE
      SHELLSTR = TRIM(OGR2OGR) // ' -skipfailures -nlt MULTILINESTRING -update -append -a_srs "' // TRIM(A_SRS) // '" ' // TRIM(OUTPUTS_DIRECTORY) // SEVEN // ".shp "  // &
                 TRIM(SCRATCH) // TRIM(FN) // ".shp" // &
      ' -dialect sqlite -sql "SELECT ST_Union(geometry) AS geometry FROM ' // TRIM(FN) // '"'

      WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR)) 
   ENDIF      

   SHELLSTR = TRIM(DELETECOMMAND) // " " // TRIM(SCRATCH) // 'isochrones_' // SEVEN // '*'; WRITE(*,100) TRIM(SHELLSTR)
   ISTAT = SYSTEM(TRIM(SHELLSTR)) 
   DUMPEDYET = .TRUE.       
ENDIF ! DUMP_ISOCHRONE_SHAPEFILES

IF (IDUMPCOUNT .EQ. NDUMPS) THEN
   FN_SURFACE_FIRE_BIL      = ' '
   FN_CROWN_FIRE_BIL        = ' '
   FN_SPREAD_RATE_BIL       = ' '
   FN_HPUA_BIL              = ' '
   FN_FLIN_BIL              = ' '
   FN_FLAME_LENGTH_BIL      = ' '
   FN_REACTION_INTENSITY_BIL= ' '
   FN_WS20_BIL              = ' '
   FN_WD20_BIL              = ' '
   FN_VELOCITY_BIL          = ' '
   FN_SPOTTING_IGN_TIME_BIL = ' '
   FN_TIME_OF_ARRIVAL_BIL   = ' '
   FN_TAGGED_BIL            = ' '
   FN_EMBER_FLUX_BIL        = ' '

   FN_SURFACE_FIRE_HDR      = ' '
   FN_CROWN_FIRE_HDR        = ' '
   FN_SPREAD_RATE_HDR       = ' '
   FN_HPUA_HDR              = ' '
   FN_FLIN_HDR              = ' '
   FN_FLAME_LENGTH_HDR      = ' '
   FN_REACTION_INTENSITY_HDR= ' '
   FN_WS20_HDR              = ' '
   FN_WD20_HDR              = ' '
   FN_VELOCITY_HDR          = ' '
   FN_SPOTTING_IGN_TIME_HDR = ' '
   FN_TIME_OF_ARRIVAL_HDR   = ' '
   FN_TAGGED_HDR            = ' '
   FN_EMBER_FLUX_HDR        = ' '

   FN_SURFACE_FIRE_TIF      = ' '
   FN_CROWN_FIRE_TIF        = ' '
   FN_SPREAD_RATE_TIF       = ' '
   FN_HPUA_TIF              = ' '
   FN_FLIN_TIF              = ' '
   FN_FLAME_LENGTH_TIF      = ' '
   FN_REACTION_INTENSITY_TIF= ' '
   FN_WS20_TIF              = ' '
   FN_WD20_TIF              = ' '
   FN_VELOCITY_TIF          = ' '
   FN_SPOTTING_IGN_TIME_TIF = ' '
   FN_TIME_OF_ARRIVAL_TIF   = ' '
   FN_TAGGED_TIF            = ' '
   FN_EMBER_FLUX_TIF        = ' '

   DIR=TRIM(OUTPUTS_DIRECTORY)
   DO IDUMPCOUNT = 1, NDUMPS
      IF (DUMP_SURFACE_FIRE          ) FN_SURFACE_FIRE_BIL       = TRIM(FN_SURFACE_FIRE_BIL       ) // " " // TRIM(DIR) // TRIM(FNS_SURFACE_FIRE      (IDUMPCOUNT)) // ".bil"
      IF (DUMP_CROWN_FIRE            ) FN_CROWN_FIRE_BIL         = TRIM(FN_CROWN_FIRE_BIL         ) // " " // TRIM(DIR) // TRIM(FNS_CROWN_FIRE        (IDUMPCOUNT)) // ".bil"
      IF (DUMP_SPREAD_RATE           ) FN_SPREAD_RATE_BIL        = TRIM(FN_SPREAD_RATE_BIL        ) // " " // TRIM(DIR) // TRIM(FNS_SPREAD_RATE       (IDUMPCOUNT)) // ".bil"
      IF (DUMP_HPUA                  ) FN_HPUA_BIL               = TRIM(FN_HPUA_BIL               ) // " " // TRIM(DIR) // TRIM(FNS_HPUA              (IDUMPCOUNT)) // ".bil"
      IF (DUMP_FLIN                  ) FN_FLIN_BIL               = TRIM(FN_FLIN_BIL               ) // " " // TRIM(DIR) // TRIM(FNS_FLIN              (IDUMPCOUNT)) // ".bil"
      IF (DUMP_FLAME_LENGTH          ) FN_FLAME_LENGTH_BIL       = TRIM(FN_FLAME_LENGTH_BIL       ) // " " // TRIM(DIR) // TRIM(FNS_FLAME_LENGTH      (IDUMPCOUNT)) // ".bil"
      IF (DUMP_REACTION_INTENSITY    ) FN_REACTION_INTENSITY_BIL = TRIM(FN_REACTION_INTENSITY_BIL ) // " " // TRIM(DIR) // TRIM(FNS_REACTION_INTENSITY(IDUMPCOUNT)) // ".bil"
      IF (DUMP_WS20                  ) FN_WS20_BIL               = TRIM(FN_WS20_BIL               ) // " " // TRIM(DIR) // TRIM(FNS_WS20              (IDUMPCOUNT)) // ".bil"
      IF (DUMP_WD20                  ) FN_WD20_BIL               = TRIM(FN_WD20_BIL               ) // " " // TRIM(DIR) // TRIM(FNS_WD20              (IDUMPCOUNT)) // ".bil"
      IF (DUMP_VELOCITY              ) FN_VELOCITY_BIL           = TRIM(FN_VELOCITY_BIL           ) // " " // TRIM(DIR) // TRIM(FNS_VELOCITY          (IDUMPCOUNT)) // ".bil"
      IF (DUMP_SPOTTING_IGNITION_TIME) FN_SPOTTING_IGN_TIME_BIL  = TRIM(FN_SPOTTING_IGN_TIME_BIL  ) // " " // TRIM(DIR) // TRIM(FNS_SPOTTING_IGN_TIME (IDUMPCOUNT)) // ".bil"
      IF (DUMP_TIME_OF_ARRIVAL       ) FN_TIME_OF_ARRIVAL_BIL    = TRIM(FN_TIME_OF_ARRIVAL_BIL    ) // " " // TRIM(DIR) // TRIM(FNS_TIME_OF_ARRIVAL   (IDUMPCOUNT)) // ".bil"
      IF (DUMP_TAGGED                ) FN_TAGGED_BIL             = TRIM(FN_TAGGED_BIL             ) // " " // TRIM(DIR) // TRIM(FNS_TAGGED            (IDUMPCOUNT)) // ".bil"
      IF (DUMP_PHI                   ) FN_PHI_BIL                = TRIM(FN_PHI_BIL                ) // " " // TRIM(DIR) // TRIM(FNS_PHI               (IDUMPCOUNT)) // ".bil"
      IF (.NOT. ACCUMULATE_EMBER_FLUX) THEN
         IF (DUMP_EMBER_FLUX            ) FN_EMBER_FLUX_BIL         = TRIM(FN_EMBER_FLUX_BIL         ) // " " // TRIM(DIR) // TRIM(FNS_EMBER_FLUX        (IDUMPCOUNT)) // ".bil"
      ENDIF

      IF (DUMP_SURFACE_FIRE          ) FN_SURFACE_FIRE_HDR       = TRIM(FN_SURFACE_FIRE_HDR       ) // " " // TRIM(DIR) // TRIM(FNS_SURFACE_FIRE      (IDUMPCOUNT)) // ".hdr"
      IF (DUMP_CROWN_FIRE            ) FN_CROWN_FIRE_HDR         = TRIM(FN_CROWN_FIRE_HDR         ) // " " // TRIM(DIR) // TRIM(FNS_CROWN_FIRE        (IDUMPCOUNT)) // ".hdr"
      IF (DUMP_SPREAD_RATE           ) FN_SPREAD_RATE_HDR        = TRIM(FN_SPREAD_RATE_HDR        ) // " " // TRIM(DIR) // TRIM(FNS_SPREAD_RATE       (IDUMPCOUNT)) // ".hdr"
      IF (DUMP_HPUA                  ) FN_HPUA_HDR               = TRIM(FN_HPUA_HDR               ) // " " // TRIM(DIR) // TRIM(FNS_HPUA              (IDUMPCOUNT)) // ".hdr"
      IF (DUMP_FLIN                  ) FN_FLIN_HDR               = TRIM(FN_FLIN_HDR               ) // " " // TRIM(DIR) // TRIM(FNS_FLIN              (IDUMPCOUNT)) // ".hdr"
      IF (DUMP_FLAME_LENGTH          ) FN_FLAME_LENGTH_HDR       = TRIM(FN_FLAME_LENGTH_HDR       ) // " " // TRIM(DIR) // TRIM(FNS_FLAME_LENGTH      (IDUMPCOUNT)) // ".hdr"
      IF (DUMP_REACTION_INTENSITY    ) FN_REACTION_INTENSITY_HDR = TRIM(FN_REACTION_INTENSITY_HDR ) // " " // TRIM(DIR) // TRIM(FNS_REACTION_INTENSITY(IDUMPCOUNT)) // ".hdr"
      IF (DUMP_WS20                  ) FN_WS20_HDR               = TRIM(FN_WS20_HDR               ) // " " // TRIM(DIR) // TRIM(FNS_WS20              (IDUMPCOUNT)) // ".hdr"
      IF (DUMP_WD20                  ) FN_WD20_HDR               = TRIM(FN_WD20_HDR               ) // " " // TRIM(DIR) // TRIM(FNS_WD20              (IDUMPCOUNT)) // ".hdr"
      IF (DUMP_VELOCITY              ) FN_VELOCITY_HDR           = TRIM(FN_VELOCITY_HDR           ) // " " // TRIM(DIR) // TRIM(FNS_VELOCITY          (IDUMPCOUNT)) // ".hdr"
      IF (DUMP_SPOTTING_IGNITION_TIME) FN_SPOTTING_IGN_TIME_HDR  = TRIM(FN_SPOTTING_IGN_TIME_HDR  ) // " " // TRIM(DIR) // TRIM(FNS_SPOTTING_IGN_TIME (IDUMPCOUNT)) // ".hdr"
      IF (DUMP_TIME_OF_ARRIVAL       ) FN_TIME_OF_ARRIVAL_HDR    = TRIM(FN_TIME_OF_ARRIVAL_HDR    ) // " " // TRIM(DIR) // TRIM(FNS_TIME_OF_ARRIVAL   (IDUMPCOUNT)) // ".hdr"
      IF (DUMP_TAGGED                ) FN_TAGGED_HDR             = TRIM(FN_TAGGED_HDR             ) // " " // TRIM(DIR) // TRIM(FNS_TAGGED            (IDUMPCOUNT)) // ".hdr"
      IF (DUMP_PHI                   ) FN_PHI_HDR                = TRIM(FN_PHI_HDR                ) // " " // TRIM(DIR) // TRIM(FNS_PHI               (IDUMPCOUNT)) // ".hdr"
      IF (.NOT. ACCUMULATE_EMBER_FLUX) THEN
         IF (DUMP_EMBER_FLUX            ) FN_EMBER_FLUX_HDR         = TRIM(FN_PHI_HDR                ) // " " // TRIM(DIR) // TRIM(FNS_EMBER_FLUX        (IDUMPCOUNT)) // ".hdr"
      ENDIF

      IF (DUMP_SURFACE_FIRE          ) FN_SURFACE_FIRE_TIF       = TRIM(FN_SURFACE_FIRE_TIF       ) // " " // TRIM(DIR) // TRIM(FNS_SURFACE_FIRE      (IDUMPCOUNT)) // ".tif"
      IF (DUMP_CROWN_FIRE            ) FN_CROWN_FIRE_TIF         = TRIM(FN_CROWN_FIRE_TIF         ) // " " // TRIM(DIR) // TRIM(FNS_CROWN_FIRE        (IDUMPCOUNT)) // ".tif"
      IF (DUMP_SPREAD_RATE           ) FN_SPREAD_RATE_TIF        = TRIM(FN_SPREAD_RATE_TIF        ) // " " // TRIM(DIR) // TRIM(FNS_SPREAD_RATE       (IDUMPCOUNT)) // ".tif"
      IF (DUMP_HPUA                  ) FN_HPUA_TIF               = TRIM(FN_HPUA_TIF               ) // " " // TRIM(DIR) // TRIM(FNS_HPUA              (IDUMPCOUNT)) // ".tif"
      IF (DUMP_FLIN                  ) FN_FLIN_TIF               = TRIM(FN_FLIN_TIF               ) // " " // TRIM(DIR) // TRIM(FNS_FLIN              (IDUMPCOUNT)) // ".tif"
      IF (DUMP_FLAME_LENGTH          ) FN_FLAME_LENGTH_TIF       = TRIM(FN_FLAME_LENGTH_TIF       ) // " " // TRIM(DIR) // TRIM(FNS_FLAME_LENGTH      (IDUMPCOUNT)) // ".tif"
      IF (DUMP_REACTION_INTENSITY    ) FN_REACTION_INTENSITY_TIF = TRIM(FN_REACTION_INTENSITY_TIF ) // " " // TRIM(DIR) // TRIM(FNS_REACTION_INTENSITY(IDUMPCOUNT)) // ".tif"
      IF (DUMP_WS20                  ) FN_WS20_TIF               = TRIM(FN_WS20_TIF               ) // " " // TRIM(DIR) // TRIM(FNS_WS20              (IDUMPCOUNT)) // ".tif"
      IF (DUMP_WD20                  ) FN_WD20_TIF               = TRIM(FN_WD20_TIF               ) // " " // TRIM(DIR) // TRIM(FNS_WD20              (IDUMPCOUNT)) // ".tif"
      IF (DUMP_VELOCITY              ) FN_VELOCITY_TIF           = TRIM(FN_VELOCITY_TIF           ) // " " // TRIM(DIR) // TRIM(FNS_VELOCITY          (IDUMPCOUNT)) // ".tif"
      IF (DUMP_SPOTTING_IGNITION_TIME) FN_SPOTTING_IGN_TIME_TIF  = TRIM(FN_SPOTTING_IGN_TIME_TIF  ) // " " // TRIM(DIR) // TRIM(FNS_SPOTTING_IGN_TIME (IDUMPCOUNT)) // ".tif"
      IF (DUMP_TIME_OF_ARRIVAL       ) FN_TIME_OF_ARRIVAL_TIF    = TRIM(FN_TIME_OF_ARRIVAL_TIF    ) // " " // TRIM(DIR) // TRIM(FNS_TIME_OF_ARRIVAL   (IDUMPCOUNT)) // ".tif"
      IF (DUMP_TAGGED                ) FN_TAGGED_TIF             = TRIM(FN_TAGGED_TIF             ) // " " // TRIM(DIR) // TRIM(FNS_TAGGED            (IDUMPCOUNT)) // ".tif"
      IF (DUMP_PHI                   ) FN_PHI_TIF                = TRIM(FN_PHI_TIF                ) // " " // TRIM(DIR) // TRIM(FNS_PHI               (IDUMPCOUNT)) // ".tif"
      IF (.NOT. ACCUMULATE_EMBER_FLUX) THEN
         IF (DUMP_EMBER_FLUX            ) FN_EMBER_FLUX_TIF         = TRIM(FN_PHI_TIF                ) // " " // TRIM(DIR) // TRIM(FNS_EMBER_FLUX        (IDUMPCOUNT)) // ".tif"
      ENDIF
   ENDDO

IF (CONVERT_TO_GEOTIFF) THEN
      IF (DUMP_SURFACE_FIRE          .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_SURFACE_FIRE_TIF       , FN_SURFACE_FIRE_HDR       , "surface_fire_      ")
      IF (DUMP_CROWN_FIRE            .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_CROWN_FIRE_TIF         , FN_CROWN_FIRE_HDR         , "crown_fire_        ")
      IF (DUMP_SPREAD_RATE           .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_SPREAD_RATE_TIF        , FN_SPREAD_RATE_HDR        , "spread_rate_       ")
      IF (DUMP_HPUA                  .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_HPUA_TIF               , FN_HPUA_HDR               , "hpua_              ")
      IF (DUMP_FLIN                  .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_FLIN_TIF               , FN_FLIN_HDR               , "flin_              ")
      IF (DUMP_FLAME_LENGTH          .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_FLAME_LENGTH_TIF       , FN_FLAME_LENGTH_HDR       , "flame_length_      ")
      IF (DUMP_REACTION_INTENSITY    .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_REACTION_INTENSITY_TIF , FN_REACTION_INTENSITY_HDR , "reaction_intensity_")
      IF (DUMP_WS20                  .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_WS20_TIF               , FN_WS20_HDR               , "ws20_              ")
      IF (DUMP_WD20                  .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_WD20_TIF               , FN_WD20_HDR               , "wd20_              ")
      IF (DUMP_VELOCITY              .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_VELOCITY_TIF           , FN_VELOCITY_HDR           , "velocity_          ")
      IF (DUMP_SPOTTING_IGNITION_TIME.AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_SPOTTING_IGN_TIME_TIF  , FN_SPOTTING_IGN_TIME_HDR  , "spot_ign_time_     ")
      IF (DUMP_TIME_OF_ARRIVAL       .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_TIME_OF_ARRIVAL_TIF    , FN_TIME_OF_ARRIVAL_HDR    , "toa_               ")
      IF (DUMP_TAGGED                .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_TAGGED_TIF             , FN_TAGGED_HDR             , "tagged_            ")
      IF (DUMP_PHI                   .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_PHI_TIF                , FN_PHI_HDR                , "phi_               ")
      IF (.NOT. ACCUMULATE_EMBER_FLUX) THEN
         IF (DUMP_EMBER_FLUX            .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_EMBER_FLUX_TIF         , FN_EMBER_FLUX_HDR         , "ember_flux_        ")
      ENDIF
ELSE
      IF (DUMP_SURFACE_FIRE          .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_SURFACE_FIRE_BIL       , FN_SURFACE_FIRE_HDR       , "surface_fire_      ")
      IF (DUMP_CROWN_FIRE            .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_CROWN_FIRE_BIL         , FN_CROWN_FIRE_HDR         , "crown_fire_        ")
      IF (DUMP_SPREAD_RATE           .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_SPREAD_RATE_BIL        , FN_SPREAD_RATE_HDR        , "spread_rate_       ")
      IF (DUMP_HPUA                  .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_HPUA_BIL               , FN_HPUA_HDR               , "hpua_              ")
      IF (DUMP_FLIN                  .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_FLIN_BIL               , FN_FLIN_HDR               , "flin_              ")
      IF (DUMP_FLAME_LENGTH          .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_FLAME_LENGTH_BIL       , FN_FLAME_LENGTH_HDR       , "flame_length_      ")
      IF (DUMP_REACTION_INTENSITY    .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_REACTION_INTENSITY_BIL , FN_REACTION_INTENSITY_HDR , "reaction_intensity_")
      IF (DUMP_WS20                  .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_WS20_BIL               , FN_WS20_HDR               , "ws20_              ")
      IF (DUMP_WD20                  .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_WD20_BIL               , FN_WD20_HDR               , "wd20_              ")
      IF (DUMP_VELOCITY              .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_VELOCITY_BIL           , FN_VELOCITY_HDR           , "velocity_          ")
      IF (DUMP_SPOTTING_IGNITION_TIME.AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_SPOTTING_IGN_TIME_BIL  , FN_SPOTTING_IGN_TIME_HDR  , "spot_ign_time_     ")
      IF (DUMP_TIME_OF_ARRIVAL       .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_TIME_OF_ARRIVAL_BIL    , FN_TIME_OF_ARRIVAL_HDR    , "toa_               ")
      IF (DUMP_TAGGED                .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_TAGGED_BIL             , FN_TAGGED_HDR             , "tagged_            ")
      IF (DUMP_PHI                   .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_PHI_BIL                , FN_PHI_HDR                , "phi_               ")
      IF (.NOT. ACCUMULATE_EMBER_FLUX) THEN
         IF (DUMP_EMBER_FLUX            .AND. CONVERT_TO_GEOTIFF) CALL MERGE_RASTERS(SEVEN, FN_EMBER_FLUX_BIL         , FN_EMBER_FLUX_HDR         , "ember_flux_        ")
      ENDIF
ENDIF

   IDUMPCOUNT = NDUMPS

   IF (DUMP_TRANSIENT_ACREAGE) CLOSE(LUOUTPUT-3) !Close acreage file
ENDIF

IDUMPCOUNT = IDUMPCOUNT + 1

100 FORMAT (A) 

! *****************************************************************************
END SUBROUTINE MAIN_DUMP_ROUTINE
! *****************************************************************************

! *****************************************************************************
SUBROUTINE MERGE_RASTERS(SEVEN,FN_LIST,FN_HDRS,STUB)
! *****************************************************************************

#ifdef __INTEL_COMPILER
USE IFPORT
#endif

CHARACTER(7), INTENT(IN) :: SEVEN
CHARACTER(20000), INTENT(IN) :: FN_LIST,FN_HDRS
CHARACTER(19), INTENT(IN) :: STUB
CHARACTER(20000) :: SHELLSTR
CHARACTER(400) :: FNOUT,FNTMP
INTEGER :: ISTAT

! Merge to multiband raster:
FNOUT=TRIM(OUTPUTS_DIRECTORY) // TRIM(STUB) // SEVEN // '.tif'

IF (TRIM(SCRATCH) .EQ. 'null' .OR. LEN_TRIM(SCRATCH) .LE. 1) THEN
   FNTMP=TRIM(OUTPUTS_DIRECTORY) // SEVEN // "_intermediate.tif " 
ELSE
   FNTMP=TRIM(SCRATCH) // SEVEN // "_intermediate.tif " 
ENDIF

SHELLSTR=TRIM(PATH_TO_GDAL) // 'gdal_merge.py -separate -init -9999 -n -9999 -a_nodata -9999 -o ' // TRIM(FNTMP) // ' ' // &
         TRIM(FN_LIST)
WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR))

SHELLSTR = TRIM(PATH_TO_GDAL) // 'gdal_translate -co "COMPRESS=DEFLATE" -co "ZLEVEL=9" -a_srs "' // TRIM(A_SRS) // '" ' // &
           TRIM(FNTMP) // ' ' // TRIM(FNOUT)
WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR))

! Clean up:
SHELLSTR = TRIM(DELETECOMMAND) // ' ' // TRIM(FN_LIST) // ' ' // TRIM(FN_HDRS) // ' ' // TRIM(FNTMP)
WRITE(*,100) TRIM(SHELLSTR); ISTAT = SYSTEM(TRIM(SHELLSTR))

100 FORMAT(A)

! *****************************************************************************
END SUBROUTINE MERGE_RASTERS
! *****************************************************************************

! *****************************************************************************
SUBROUTINE FIRE_SIZE_STATS_TO_RASTERS(PREFIX, VALS)
! *****************************************************************************

CHARACTER(60), INTENT(IN) :: PREFIX
CHARACTER(400) :: FN
REAL, DIMENSION(:), INTENT(IN) :: VALS

INTEGER :: I, ICASE, IWX_BAND, IX, IY
TYPE (RASTER_TYPE), SAVE :: DUMMY
CHARACTER(4) :: SUFFIX

IF (.NOT. ASSOCIATED(DUMMY%R4)) THEN
   CALL ALLOCATE_EMPTY_RASTER(DUMMY, ASP%NCOLS, ASP%NROWS, 1, ASP%XLLCORNER, ASP%YLLCORNER, ASP%CELLSIZE, 0., 'FLOAT     ')
ENDIF

IF (DUMP_HOURLY_RASTERS .AND. .NOT. DUMP_HOURLY_RASTERS_ASAP) THEN
   ICASE = 0
   DO IWX_BAND = IWX_BAND_START, IWX_BAND_STOP, IWX_BAND_SKIP
      DUMMY%R4(:,:,1) = 0.
      DO I = 1, NUM_CASES_PER_STARTING_WX_BAND(IWX_BAND)
         ICASE = ICASE + 1
         IX = ICOL_FROM_X(STATS_X(ICASE),ANALYSIS_XLLCORNER,ANALYSIS_CELLSIZE)
         IY = IROW_FROM_Y(STATS_Y(ICASE),ANALYSIS_YLLCORNER,ANALYSIS_CELLSIZE)
         DUMMY%R4(IX,IY,1) = VALS(ICASE)
      ENDDO
      WRITE(SUFFIX, '(I4.4)') IWX_BAND
      FN = TRIM(PREFIX) // '_'  // SUFFIX
      CALL WRITE_BIL_RASTER_ONEBAND(DUMMY, OUTPUTS_DIRECTORY, FN, CONVERT_TO_GEOTIFF, .TRUE.) 
   ENDDO
ENDIF

DUMMY%R4(:,:,1) = 0.
DO ICASE = 1, NUM_CASES_TOTAL
   IX = ICOL_FROM_X(STATS_X(ICASE),ANALYSIS_XLLCORNER,ANALYSIS_CELLSIZE)
   IY = IROW_FROM_Y(STATS_Y(ICASE),ANALYSIS_YLLCORNER,ANALYSIS_CELLSIZE)
   DUMMY%R4(IX,IY,1) = STATS_SURFACE_FIRE_AREA(ICASE)
ENDDO
FN = TRIM(PREFIX)
CALL WRITE_BIL_RASTER_ONEBAND(DUMMY, OUTPUTS_DIRECTORY, FN, CONVERT_TO_GEOTIFF, .TRUE.) 

! *****************************************************************************
END SUBROUTINE FIRE_SIZE_STATS_TO_RASTERS
! *****************************************************************************

! *****************************************************************************
SUBROUTINE FIRE_SIZE_STATS_TO_RASTERS_HOURLY(PREFIX, VALS, IWX_BAND_TO_DUMP)
! *****************************************************************************

INTEGER, INTENT(IN) :: IWX_BAND_TO_DUMP
CHARACTER(60), INTENT(IN) :: PREFIX
CHARACTER(400) :: FN
REAL, DIMENSION(:), INTENT(IN) :: VALS

INTEGER :: I, ICASE, IWX_BAND, IX, IY
TYPE (RASTER_TYPE), SAVE :: DUMMY
CHARACTER(4) :: SUFFIX

IF (.NOT. ASSOCIATED(DUMMY%R4)) THEN
   CALL ALLOCATE_EMPTY_RASTER(DUMMY, ASP%NCOLS, ASP%NROWS, 1, ASP%XLLCORNER, ASP%YLLCORNER, ASP%CELLSIZE, 0., 'FLOAT     ')
ENDIF
DUMMY%R4(:,:,1) = 0.

IF (IWX_BAND_TO_DUMP .EQ. 0) THEN
   DO ICASE = 1, NUM_CASES_TOTAL
      IX = ICOL_FROM_X(STATS_X(ICASE),ANALYSIS_XLLCORNER,ANALYSIS_CELLSIZE)
      IY = IROW_FROM_Y(STATS_Y(ICASE),ANALYSIS_YLLCORNER,ANALYSIS_CELLSIZE)
      DUMMY%R4(IX,IY,1) = STATS_SURFACE_FIRE_AREA(ICASE)
   ENDDO
   FN = TRIM(PREFIX)
ELSE
   ICASE = 0
   DO IWX_BAND = IWX_BAND_START, IWX_BAND_TO_DUMP, IWX_BAND_SKIP
      IF (IWX_BAND .NE. IWX_BAND_TO_DUMP) ICASE = ICASE + NUM_CASES_PER_STARTING_WX_BAND(IWX_BAND)
   ENDDO

   DO I = 1, NUM_CASES_PER_STARTING_WX_BAND(IWX_BAND_TO_DUMP)
      ICASE = ICASE + 1
      IX = ICOL_FROM_X(STATS_X(ICASE),ANALYSIS_XLLCORNER,ANALYSIS_CELLSIZE)
      IY = IROW_FROM_Y(STATS_Y(ICASE),ANALYSIS_YLLCORNER,ANALYSIS_CELLSIZE)
      DUMMY%R4(IX,IY,1) = VALS(ICASE)
   ENDDO

   WRITE(SUFFIX, '(I4.4)') IWX_BAND_TO_DUMP
   FN = TRIM(PREFIX) // '_'  // SUFFIX
ENDIF

CALL WRITE_BIL_RASTER_ONEBAND(DUMMY, OUTPUTS_DIRECTORY, FN, CONVERT_TO_GEOTIFF, .TRUE.) 

! *****************************************************************************
END SUBROUTINE FIRE_SIZE_STATS_TO_RASTERS_HOURLY
! *****************************************************************************

! *****************************************************************************
SUBROUTINE WRITE_PROGRESS_MESSAGE(MESSAGESTR)
! *****************************************************************************

CHARACTER(400), INTENT(IN) :: MESSAGESTR
CHARACTER(400) :: FN
INTEGER :: IOS
INTEGER, PARAMETER :: LU = 100000

FN = TRIM(OUTPUTS_DIRECTORY) // 'progress_messages_fifo'
OPEN(LU,FILE=TRIM(FN),FORM='FORMATTED',ACCESS='STREAM',STATUS='OLD',ACTION='WRITE',IOSTAT=IOS)

IF (IOS .EQ. 0) THEN
   WRITE(*,*) TRIM(MESSAGESTR)
   WRITE(LU,'(A)') TRIM(MESSAGESTR)
   CLOSE(LU)
ENDIF

! *****************************************************************************
END SUBROUTINE WRITE_PROGRESS_MESSAGE
! *****************************************************************************

! *****************************************************************************
SUBROUTINE POSTPROCESS
! *****************************************************************************

INTEGER :: I, IX, IY, IOS, IBAND, IWX_BAND, J, LUSTATS, IERR=0, IPYROME
LOGICAL :: LOPEN
CHARACTER(4) :: SUFFIX
CHARACTER(7) :: CID
CHARACTER(16) :: TIMESTAMP
CHARACTER(81) :: PREFIX
CHARACTER(88) :: FIRE_ID
CHARACTER(400) :: FN, HEADER
TYPE(RASTER_TYPE) :: INTERMEDIATE
TYPE(RASTER_TYPE), POINTER :: R

IF (IRANK_WORLD .EQ. 0 .AND. DUMP_FIRE_SIZE_STATS) THEN

   LUSTATS = LUOUTPUT - 2
   INQUIRE(UNIT=LUSTATS,OPENED=LOPEN)
   IF (LOPEN) CLOSE(LUSTATS)

   FN = TRIM(OUTPUTS_DIRECTORY) // 'fire_size_stats.csv'
   OPEN(LUSTATS,FILE=TRIM(FN),FORM='FORMATTED',STATUS='REPLACE',IOSTAT=IOS)
   WRITE(LUSTATS,'(A)') 'icase,Meteorology band,x,y,tstop (h),Wall clock time (s),Total fire area (ac),&
                         Crown fire area (ac),Fire volume (ac-ft),Population affected,Real estate value,&
                         Land value,Nembers,Pyrome,Containfrac,PM 2.5 release (ug),HRR peak (MW),&
                         Start timestamp,Fire id'

   IPYROME=1

   IF (TRIM(RUN_ID) .EQ. '') THEN
      PREFIX = ''
   ELSE
      PREFIX = TRIM(RUN_ID) // '_'
   ENDIF

   DO I = 1, NUM_CASES_TOTAL
      IF (RANDOM_IGNITIONS) THEN
         IF (USE_PYROMES) THEN
            IX = ICOL_FROM_X(STATS_X(I),ANALYSIS_XLLCORNER,ANALYSIS_CELLSIZE)
            IY = IROW_FROM_Y(STATS_Y(I),ANALYSIS_YLLCORNER,ANALYSIS_CELLSIZE)
            IPYROME = PYROMES%I2(IX,IY,1)
         ENDIF
      ELSE
         STATS_X(I) = 0.
         STATS_Y(I) = 0.
      ENDIF
      TIMESTAMP = HOUR_OF_YEAR_TO_TIMESTAMP (CURRENT_YEAR, BAND_ONE_HOUR_OF_YEAR + STATS_IWX_BAND_START(I) - 1)
      WRITE(CID, '(I7.7)') I
      FIRE_ID = TRIM(PREFIX) // CID
      WRITE(LUSTATS,9999) I, STATS_IWX_BAND_START(I), STATS_X(I), STATS_Y(I), STATS_SIMULATION_TSTOP_HOURS(I), &
                          STATS_WALL_CLOCK_TIME(I), STATS_SURFACE_FIRE_AREA(I), STATS_CROWN_FIRE_AREA(I), & 
                          STATS_FIRE_VOLUME(I), STATS_AFFECTED_POPULATION(I), STATS_AFFECTED_REAL_ESTATE_VALUE(I), &
                          STATS_AFFECTED_LAND_VALUE(I), INT(STATS_NEMBERS(I)),IPYROME, STATS_FINAL_CONTAINMENT_FRAC(I), &
                          STATS_PM2P5_RELEASE(I), STATS_HRR_PEAK(I), TRIM(TIMESTAMP), TRIM(FIRE_ID)
   ENDDO
   CLOSE(LUSTATS)
!         ICASE      BAND       X,Y          TSTOP      CLOCK      Fire           Emb   Pyrm   Containfrac     PM,HRR     TS      ID 
9999 FORMAT(I7, ',', I5, ',', 2(F11.2, ','), F8.2, ',', F9.4, ',', 6(F13.1, ','), I7,',',I3, ',', F9.3, ',', 2(E9.3, ','), A, ',', A)

ENDIF

IF (IRANK_WORLD .EQ. 0 .AND. NUM_MONTE_CARLO_VARIABLES .GT. 0) THEN
   HEADER='ICASE'
   IF (NUM_PARAMETERS_RASTERS .GT. 0) THEN
      DO I = 1, NUM_PARAMETERS_RASTERS
         HEADER = TRIM(HEADER) // ',' // TRIM(RASTER_TO_PERTURB(I))
      ENDDO
   ENDIF

   IF (ENABLE_SPOTTING) HEADER = TRIM(HEADER) // ',MSD,NSDV,SWE,SFE,NEMX,GSFSP,CFSP,PIGN'
   IF (PERTURB_WIND_DIRECTION_FLUCTUATION_INTENSITY) HEADER = TRIM(HEADER) // ',WDFI'
   IF (PERTURB_WIND_SPEED_FLUCTUATION_INTENSITY)     HEADER = TRIM(HEADER) // ',WSFI'
   HEADER=TRIM(HEADER) // ','

   FN = TRIM(OUTPUTS_DIRECTORY) // 'coeffs.csv'
   OPEN(LUSTATS,FILE=TRIM(FN),FORM='FORMATTED',STATUS='REPLACE',IOSTAT=IOS)
   WRITE(LUSTATS,'(A)') TRIM(HEADER)
   DO I = 1, NUM_CASES_TOTAL
      WRITE(LUSTATS,9998) I, (COEFFS_UNSCALED_BY_CASE(I,J), J = 1, NUM_MONTE_CARLO_VARIABLES) 
   ENDDO
   CLOSE(LUSTATS)

ENDIF
9998 FORMAT (I7,',',25(F9.4,','))

IF (CALCULATE_TIMES_BURNED .AND. IRANK_WORLD .EQ. PARALLEL_IO_RANK(34)) THEN
   FN='times_burned'
   CALL WRITE_BIL_RASTER_ONEBAND(TIMES_BURNED, OUTPUTS_DIRECTORY, FN, CONVERT_TO_GEOTIFF, .TRUE.)

   IF (DUMP_HOURLY_RASTERS) THEN
      IBAND = 0
      DO IWX_BAND = IWX_BAND_START, IWX_BAND_STOP, IWX_BAND_SKIP
         IBAND = IBAND + 1
         IF ( ( NUM_CASES_PER_STARTING_WX_BAND(IWX_BAND) .EQ. 0) .OR. (.NOT. DUMP_HOURLY_RASTERS_ASAP) ) THEN
            WRITE(SUFFIX, '(I4.4)') IWX_BAND
            FN = 'times_burned' // '_'  // SUFFIX
            TIMES_BURNED%R4(:,:,1) = TIMES_BURNED_HOURLY%R4(:,:,IBAND)
            CALL WRITE_BIL_RASTER_ONEBAND(TIMES_BURNED, OUTPUTS_DIRECTORY, FN, CONVERT_TO_GEOTIFF, .TRUE.) 
         ENDIF
      ENDDO
   ENDIF
ENDIF

IF (DUMP_SURFACE_FIRE_AREA .AND. IRANK_WORLD .EQ. PARALLEL_IO_RANK(35)) THEN
   PREFIX = 'surface_fire_area'
   CALL FIRE_SIZE_STATS_TO_RASTERS(PREFIX, STATS_SURFACE_FIRE_AREA(:) )
   IF (DUMP_HOURLY_RASTERS) THEN
      DO IWX_BAND = IWX_BAND_START, IWX_BAND_STOP, IWX_BAND_SKIP
         IF ( ( NUM_CASES_PER_STARTING_WX_BAND(IWX_BAND) .EQ. 0) .OR. (.NOT. DUMP_HOURLY_RASTERS_ASAP) ) THEN
            CALL FIRE_SIZE_STATS_TO_RASTERS_HOURLY(PREFIX, STATS_SURFACE_FIRE_AREA(:), IWX_BAND )
         ENDIF
      ENDDO
   ENDIF
ENDIF

IF (DUMP_CROWN_FIRE_AREA .AND. IRANK_WORLD .EQ. PARALLEL_IO_RANK(36)) THEN
   PREFIX = 'crown_fire_area'
   CALL FIRE_SIZE_STATS_TO_RASTERS(PREFIX, STATS_CROWN_FIRE_AREA(:) )
   IF (DUMP_HOURLY_RASTERS) THEN
      DO IWX_BAND = IWX_BAND_START, IWX_BAND_STOP, IWX_BAND_SKIP
         IF ( ( NUM_CASES_PER_STARTING_WX_BAND(IWX_BAND) .EQ. 0) .OR. (.NOT. DUMP_HOURLY_RASTERS_ASAP) ) THEN
            CALL FIRE_SIZE_STATS_TO_RASTERS_HOURLY(PREFIX, STATS_CROWN_FIRE_AREA(:), IWX_BAND )
         ENDIF
      ENDDO
   ENDIF
ENDIF

IF (DUMP_FIRE_VOLUME .AND. IRANK_WORLD .EQ. PARALLEL_IO_RANK(37)) THEN
   PREFIX = 'fire_volume'
   CALL FIRE_SIZE_STATS_TO_RASTERS(PREFIX, STATS_FIRE_VOLUME(:) )
   IF (DUMP_HOURLY_RASTERS) THEN
      DO IWX_BAND = IWX_BAND_START, IWX_BAND_STOP, IWX_BAND_SKIP
         IF ( ( NUM_CASES_PER_STARTING_WX_BAND(IWX_BAND) .EQ. 0) .OR. (.NOT. DUMP_HOURLY_RASTERS_ASAP) ) THEN
            CALL FIRE_SIZE_STATS_TO_RASTERS_HOURLY(PREFIX, STATS_FIRE_VOLUME(:), IWX_BAND )
         ENDIF
      ENDDO
   ENDIF
ENDIF

IF (DUMP_AFFECTED_POPULATION .AND. IRANK_WORLD .EQ. PARALLEL_IO_RANK(38)) THEN
   PREFIX = 'affected_population'
   CALL FIRE_SIZE_STATS_TO_RASTERS(PREFIX, STATS_AFFECTED_POPULATION(:) )
   IF (DUMP_HOURLY_RASTERS) THEN
      DO IWX_BAND = IWX_BAND_START, IWX_BAND_STOP, IWX_BAND_SKIP
         IF ( ( NUM_CASES_PER_STARTING_WX_BAND(IWX_BAND) .EQ. 0) .OR. (.NOT. DUMP_HOURLY_RASTERS_ASAP) ) THEN
            CALL FIRE_SIZE_STATS_TO_RASTERS_HOURLY(PREFIX, STATS_AFFECTED_POPULATION(:), IWX_BAND )
         ENDIF
      ENDDO
   ENDIF
ENDIF

IF (DUMP_AFFECTED_REAL_ESTATE_VALUE .AND. IRANK_WORLD .EQ. PARALLEL_IO_RANK(39)) THEN
   PREFIX = 'affected_real_estate_value'
   CALL FIRE_SIZE_STATS_TO_RASTERS(PREFIX, STATS_AFFECTED_REAL_ESTATE_VALUE(:) )
   IF (DUMP_HOURLY_RASTERS) THEN
      DO IWX_BAND = IWX_BAND_START, IWX_BAND_STOP, IWX_BAND_SKIP
         IF ( ( NUM_CASES_PER_STARTING_WX_BAND(IWX_BAND) .EQ. 0) .OR. (.NOT. DUMP_HOURLY_RASTERS_ASAP) ) THEN
            CALL FIRE_SIZE_STATS_TO_RASTERS_HOURLY(PREFIX, STATS_AFFECTED_REAL_ESTATE_VALUE(:), IWX_BAND )
         ENDIF
      ENDDO
   ENDIF
ENDIF

IF (DUMP_AFFECTED_LAND_VALUE .AND. IRANK_WORLD .EQ. PARALLEL_IO_RANK(40)) THEN
   PREFIX = 'affected_land_value'
   CALL FIRE_SIZE_STATS_TO_RASTERS(PREFIX, STATS_AFFECTED_LAND_VALUE(:) )
   IF (DUMP_HOURLY_RASTERS) THEN
      DO IWX_BAND = IWX_BAND_START, IWX_BAND_STOP, IWX_BAND_SKIP
         IF ( ( NUM_CASES_PER_STARTING_WX_BAND(IWX_BAND) .EQ. 0) .OR. (.NOT. DUMP_HOURLY_RASTERS_ASAP) ) THEN
            CALL FIRE_SIZE_STATS_TO_RASTERS_HOURLY(PREFIX, STATS_AFFECTED_LAND_VALUE(:), IWX_BAND )
         ENDIF
      ENDDO
   ENDIF
ENDIF

IF (IRANK_WORLD .EQ. 0) THEN
   IF (CALCULATE_TIMES_BURNED .AND. CALCULATE_FLAME_LENGTH_STATS) THEN
      FN='flame_length_max'
      CALL WRITE_BIL_RASTER_ONEBAND(FLAME_LENGTH_MAX, OUTPUTS_DIRECTORY, FN, CONVERT_TO_GEOTIFF, .TRUE.)

      FN='flame_length_sum'
      CALL WRITE_BIL_RASTER_ONEBAND(FLAME_LENGTH_SUM, OUTPUTS_DIRECTORY, FN, CONVERT_TO_GEOTIFF, .TRUE.)

      IF (USE_FLAME_LENGTH_BINS) THEN
          FN='flame_length_bin_counts'
          CALL WRITE_BIL_RASTER(FLAME_LENGTH_BIN_COUNT, OUTPUTS_DIRECTORY, FN, CONVERT_TO_GEOTIFF, .TRUE.)
      ENDIF
   ENDIF
   IF (USE_EMBER_COUNT_BINS) THEN
       FN='ember_bin_counts'
       CALL WRITE_BIL_RASTER(EMBER_BIN_COUNT, OUTPUTS_DIRECTORY, FN, CONVERT_TO_GEOTIFF, .TRUE.)
   ENDIF

ENDIF 

CALL MPI_BARRIER(MPI_COMM_WORLD, IERR)

IF (DUMP_EMBER_FLUX .AND. ACCUMULATE_EMBER_FLUX) THEN
   R=>TIMES_BURNED
   CALL ALLOCATE_EMPTY_RASTER(INTERMEDIATE, R%NCOLS, R%NROWS, 1, R%XLLCORNER, R%YLLCORNER, R%CELLSIZE, 0., 'SIGNEDINT ')

   CALL MPI_REDUCE(EMBER_FLUX%I2(:,:,1), INTERMEDIATE%I2(:,:,1), ANALYSIS_NCOLS*ANALYSIS_NROWS, &
                   MPI_SHORT, MPI_SUM, 0, MPI_COMM_WORLD, IERR)
   IF (IRANK_WORLD .EQ. 0) THEN
      FN='ember_flux'
      CALL WRITE_BIL_RASTER_ONEBAND(INTERMEDIATE, OUTPUTS_DIRECTORY, FN, CONVERT_TO_GEOTIFF, .TRUE.)
   ENDIF
ENDIF

! *****************************************************************************
END SUBROUTINE POSTPROCESS
! *****************************************************************************

! *****************************************************************************
END MODULE ELMFIRE_IO
! *****************************************************************************